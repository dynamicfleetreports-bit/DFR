<!DOCTYPE html>
<html lang="en">
<head>
	<script type="module" src="firebase-helper.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Intel | Forensic Audit Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #e2e8f0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 260px; background: #0f172a; border-right: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; padding: 2rem 1rem; }
        .main-wrapper { flex: 1; overflow-y: auto; padding: 2rem; background: radial-gradient(circle at top right, #0f172a, #020617); position: relative; }
        
        .audit-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.5rem; padding: 1.2rem; margin-bottom: 1.5rem; }
        
        .control-bar { display: flex; align-items: center; gap: 1rem; background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 1.25rem; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 1.5rem; }
        .upload-tile { padding: 0.6rem 1.2rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: space-between; flex: 1; }
        
        .var-input-box { display: flex; flex-direction: column; align-items: center; border-left: 1px solid rgba(255,255,255,0.1); padding: 0 15px; }
        .var-label { font-size: 9px; font-weight: 900; text-transform: uppercase; opacity: 0.5; margin-bottom: 4px; }
        .var-val { background: transparent; color: white; font-weight: 900; font-size: 14px; width: 55px; text-align: center; outline: none; border-bottom: 2px solid transparent; }

        .col-reg { flex: 1; min-width: 110px; } 
        .col-type { flex: 1; min-width: 90px; } 
        .col-data { flex: 1; min-width: 70px; text-align: center; } 
        .col-drift { flex: 1; min-width: 65px; text-align: center; font-weight: 900; } 
        .col-perf { flex: 1; min-width: 75px; text-align: center; }
        .col-score { flex: 1; min-width: 70px; text-align: center; font-weight: 900; } 
        .col-money { flex: 1; min-width: 95px; text-align: center; }
        .col-events { flex: 1; min-width: 80px; text-align: center; font-weight: 900; }

        .grid-header { font-size: 9px; font-weight: 900; text-transform: uppercase; color: #10b981; opacity: 0.6; display: flex; gap: 10px; padding: 0 1rem; margin-bottom: 1rem; }
        .vehicle-row { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.03); margin-bottom: 0.4rem; border-radius: 0.75rem; display: flex; gap: 10px; padding: 0.6rem 1rem; align-items: center; }
        .manual-input { background: #020617; border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.3rem; color: white; width: 100%; font-size: 12px; outline: none; text-align: center; }
        .manual-input::-webkit-outer-spin-button,
        .manual-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .manual-input[type=number] {
            -moz-appearance: textfield;
        }
        /* Also remove spinners from header inputs */
.var-val::-webkit-outer-spin-button,
.var-val::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.var-val[type=number] {
    -moz-appearance: textfield;
}
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.2rem; }
        .data-card { background: rgba(15, 23, 42, 0.8); border-left: 4px solid #10b981; padding: 1.2rem; border-radius: 1rem; }
        .data-card.retail { border-left-color: #6366f1; }
        .card-label { font-size: 9px; font-weight: 900; text-transform: uppercase; opacity: 0.5; display: block; }
        .card-value { font-size: 1.4rem; font-weight: 900; display: block; margin-top: 4px; }

        #mapper-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: #0f172a; border: 1px solid #10b981; border-radius: 2rem; padding: 2.5rem; width: 420px; }
    </style>
</head>
<body onload="initAudit()">

    <div id="mapper-modal">
        <div class="modal-box text-white">
            <h2 class="text-xl font-black mb-4 uppercase text-center text-emerald-500">Map Data Columns</h2>
            <div class="space-y-4">
                <div><label class="text-[9px] font-black uppercase opacity-50 block mb-1">Registration</label><select id="map-reg" class="w-full bg-slate-900 p-3 rounded-lg border border-white/10 text-xs text-white"></select></div>
                <div><label class="text-[9px] font-black uppercase opacity-50 block mb-1">Value (KM/Speed)</label><select id="map-val" class="w-full bg-slate-900 p-3 rounded-lg border border-white/10 text-xs text-white"></select></div>
                <div id="usage-extra-fields" style="display:none;">
                    <label class="text-[9px] font-black uppercase opacity-50 block mb-1">Over Speed Duration (seconds)</label>
                    <select id="map-duration" class="w-full bg-slate-900 p-3 rounded-lg border border-white/10 text-xs text-white"></select>
                    <label class="text-[9px] font-black uppercase opacity-50 block mb-1 mt-3">Max Speed</label>
                    <select id="map-maxspeed" class="w-full bg-slate-900 p-3 rounded-lg border border-white/10 text-xs text-white"></select>
                </div>
                <div id="logic-selector-box">
                    <label class="text-[9px] font-black uppercase opacity-50 block mb-1">Distance Calculation</label>
                  <select id="map-logic" class="w-full bg-slate-900 p-3 rounded-lg border border-white/10 text-xs text-white">
    <option value="sum" selected>Sum (Adds all rows)</option>
    <option value="latest">Latest (Uses highest value)</option>
</select>
                </div>
                <div><label class="text-[9px] font-black uppercase opacity-50 block mb-1">Audit Date</label><select id="map-date" class="w-full bg-slate-900 p-3 rounded-lg border border-white/10 text-xs text-white"></select></div>
            </div>
            <button onclick="commitMapping()" class="w-full mt-8 bg-emerald-500 text-slate-900 font-black py-4 rounded-xl uppercase text-[11px] hover:bg-emerald-400">Confirm & Process</button>
        </div>
    </div>

    <aside id="sidebar">
        <div class="logo-area mb-10"><img src="Logo.png" alt="Logo" style="max-width: 140px;"></div>
        <nav class="space-y-1">
            <a href="index.html" class="flex items-center p-3 text-xs font-bold uppercase text-slate-500">Dashboard</a>
            <a href="pipeline.html" class="flex items-center p-3 text-xs font-bold uppercase text-slate-500">Pipeline</a>
            <a href="audit.html" class="flex items-center p-3 text-xs font-bold uppercase text-emerald-500 bg-emerald-500/5 rounded-lg">Forensic Audit</a>
        </nav>
    </aside>

    <main class="main-wrapper">
        <div class="mb-6">
            <h1 class="text-3xl font-black italic uppercase text-white leading-none">
                Efficiency Audit : <span id="client-name" class="text-emerald-500">NO CLIENT SELECTED</span>
            </h1>
            <div class="flex gap-6 mt-3">
                <div class="bg-emerald-500/10 border border-emerald-500/30 px-6 py-3 rounded-xl">
                    <p class="text-[9px] font-black text-emerald-400 uppercase tracking-widest opacity-60">Audit Period</p>
                    <p id="audit-period" class="text-sm font-black text-emerald-400 uppercase mt-1">JAN 2026</p>
                </div>
                <div class="bg-orange-500/10 border border-orange-500/30 px-6 py-3 rounded-xl">
                    <p class="text-[9px] font-black text-orange-400 uppercase tracking-widest opacity-60">Status</p>
                    <p id="date-label" class="text-[10px] font-black text-orange-400 uppercase mt-1">DATA PENDING</p>
                </div>
            </div>
        </div>

        <div class="control-bar">
            <div class="upload-tile bg-emerald-500/5 border border-emerald-500/20">
                <div class="flex items-center"><span id="stat-usage" class="text-red-500 font-bold mr-2">‚úò</span><span class="text-[10px] font-black uppercase">Usage CSV</span></div>
                <button onclick="document.getElementById('csv-usage').click()" class="bg-white/10 px-4 py-2 rounded-lg text-[10px] font-black uppercase border border-white/10 hover:bg-emerald-500/20">Upload</button>
                <input type="file" id="csv-usage" class="hidden" onchange="launchMapper(this, 'usage')">
            </div>
            <div class="upload-tile bg-orange-500/5 border border-orange-500/20">
                <div class="flex items-center"><span id="stat-speed" class="text-red-500 font-bold mr-2">‚úò</span><span class="text-[10px] font-black uppercase">Violation CSV</span></div>
                <button onclick="document.getElementById('csv-speed').click()" class="bg-white/10 px-4 py-2 rounded-lg text-[10px] font-black uppercase border border-white/10 hover:bg-orange-500/20">Upload</button>
                <input type="file" id="csv-speed" class="hidden" onchange="launchMapper(this, 'speed')">
            </div>
            <div class="var-input-box"><span class="var-label">Speed Limit</span><input type="number" id="master-speed" value="80" class="var-val" step="1" oninput="renderGrid()"></div>
            <div class="var-input-box"><span class="var-label">Wholesale</span><input type="number" id="price-w" value="21.50" class="var-val text-emerald-400" step="0.01" oninput="renderGrid()"></div>
            <div class="var-input-box"><span class="var-label">Retail</span><input type="number" id="price-r" value="23.85" class="var-val text-indigo-400" step="0.01" oninput="renderGrid()"></div>
            <div class="var-input-box"><span class="var-label">Target km/L</span><input type="number" id="master-target" value="2.3" class="var-val" step="0.01" oninput="renderGrid()"></div>
        </div>

        <div class="audit-panel">
            <div class="grid-header">
                <div class="col-reg">Registration</div>
                <div class="col-type">Type</div>
                <div class="col-data">GPS KM</div>
                <div class="col-data">Act Odo</div>
                <div class="col-drift">Drift</div>
                <div class="col-money">Eff. Loss</div>
                <div class="col-data">Liters</div>
                <div class="col-perf">Wasted L</div>
                <div class="col-perf">Act km/L</div>
                <div class="col-events">Events</div>
                <div class="col-money">Speed Loss</div>
                <div class="col-money">Total Loss</div>
                <div class="col-score">Score</div>
            </div>
            <div id="grid-rows" class="space-y-1 max-h-[350px] overflow-y-auto pr-2"></div>
        </div>

        <div class="summary-grid mb-4">
            <div class="data-card"><span class="card-label">Wholesale Eff. Loss</span><span id="l1-eff" class="card-value">R 0</span></div>
            <div class="data-card"><span class="card-label">Wholesale Speed Loss</span><span id="l1-speed" class="card-value">R 0</span></div>
            <div class="data-card" style="background:#064e3b;"><span class="card-label text-white">Wholesale Total Impact</span><span id="l1-total" class="card-value text-white">R 0</span></div>
        </div>
        <div class="summary-grid mb-4">
            <div class="data-card retail"><span class="card-label">Retail Eff. Loss</span><span id="l2-eff" class="card-value">R 0</span></div>
            <div class="data-card retail"><span class="card-label">Retail Speed Loss</span><span id="l2-speed" class="card-value">R 0</span></div>
            <div class="data-card retail" style="background:#1e1b4b;"><span class="card-label text-white">Retail Total Impact</span><span id="l2-total" class="card-value text-white">R 0</span></div>
        </div>

        <div class="audit-panel mt-6">
            <h2 class="text-xl font-black uppercase text-emerald-400 mb-4">üèÜ Performance Bonus Summary</h2>
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-yellow-500/10 border border-yellow-500/30 p-4 rounded-xl text-center">
                    <p class="text-[9px] font-black text-yellow-400 uppercase opacity-60">Elite Drivers</p>
                    <p id="bonus-elite-count" class="text-3xl font-black text-yellow-400 mt-1">0</p>
                    <p class="text-[8px] text-yellow-400/60 mt-1">95-100 Score</p>
                </div>
                <div class="bg-emerald-500/10 border border-emerald-500/30 p-4 rounded-xl text-center">
                    <p class="text-[9px] font-black text-emerald-400 uppercase opacity-60">High Performers</p>
                    <p id="bonus-high-count" class="text-3xl font-black text-emerald-400 mt-1">0</p>
                    <p class="text-[8px] text-emerald-400/60 mt-1">90-94 Score</p>
                </div>
                <div class="bg-blue-500/10 border border-blue-500/30 p-4 rounded-xl text-center">
                    <p class="text-[9px] font-black text-blue-400 uppercase opacity-60">Good Drivers</p>
                    <p id="bonus-good-count" class="text-3xl font-black text-blue-400 mt-1">0</p>
                    <p class="text-[8px] text-blue-400/60 mt-1">80-89 Score</p>
                </div>
                <div class="bg-red-500/10 border border-red-500/30 p-4 rounded-xl text-center">
                    <p class="text-[9px] font-black text-red-400 uppercase opacity-60">Needs Improvement</p>
                    <p id="bonus-poor-count" class="text-3xl font-black text-red-400 mt-1">0</p>
                    <p class="text-[8px] text-red-400/60 mt-1">Below 80</p>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-gradient-to-br from-emerald-500/20 to-emerald-500/5 border border-emerald-500/30 p-4 rounded-xl">
                    <p class="text-[9px] font-black text-emerald-400 uppercase opacity-60">Estimated Monthly Bonus</p>
                    <p id="bonus-total" class="text-2xl font-black text-emerald-400 mt-2">R 0</p>
                    <p class="text-[8px] text-emerald-400/60 mt-1">Elite: R500 | High: R300 | Good: R150</p>
                </div>
                <div class="bg-gradient-to-br from-yellow-500/20 to-yellow-500/5 border border-yellow-500/30 p-4 rounded-xl">
                    <p class="text-[9px] font-black text-yellow-400 uppercase opacity-60">Monthly Savings from Bonused Drivers</p>
                    <p id="bonus-savings" class="text-2xl font-black text-yellow-400 mt-2">R 0</p>
                    <p class="text-[8px] text-yellow-400/60 mt-1">Fuel waste prevented by top performers</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500/20 to-blue-500/5 border border-blue-500/30 p-4 rounded-xl">
                    <p class="text-[9px] font-black text-blue-400 uppercase opacity-60">Net ROI</p>
                    <p id="bonus-roi" class="text-2xl font-black text-blue-400 mt-2">R 0</p>
                    <p class="text-[8px] text-blue-400/60 mt-1">Savings minus bonus payout</p>
                </div>
            </div>
            
            <div class="mt-4 p-4 bg-blue-500/5 border border-blue-500/20 rounded-lg">
                <p class="text-[10px] font-bold text-blue-300">üí° <strong>Performance Incentive Recommendation:</strong> Implement a monthly bonus structure to reward high-scoring drivers. This self-funds through fuel savings while improving driver behavior, safety, and retention.</p>
            </div>
        </div>

        <div class="mt-8 flex gap-4">
            <button onclick="saveAuditResults()" class="flex-1 bg-emerald-500 text-slate-900 font-black py-4 rounded-xl uppercase text-[11px] hover:bg-emerald-400 transition shadow-lg">üíæ Save Audit Results</button>
            <button onclick="generateReport()" class="flex-1 bg-blue-500 text-white font-black py-4 rounded-xl uppercase text-[11px] hover:bg-blue-400 transition shadow-lg">üìÑ Generate Report</button>
            <button onclick="window.location.href='pipeline.html'" class="flex-1 bg-white/5 border border-white/10 text-white font-black py-4 rounded-xl uppercase text-[11px] hover:bg-white/10 transition">‚Üê Back</button>
        </div>
    </main>

    <script>
        let auditData = {};
        let activeRows = [];
        let activeMode = '';
        let currentClientName = '';
        let lastUploadTimestamp = { usage: 0, speed: 0 };
	async function initAudit() {
    const urlParams = new URLSearchParams(window.location.search);
    const clientFromUrl = urlParams.get('client');
    
    if(clientFromUrl) {
        const decodedClient = decodeURIComponent(clientFromUrl);
        currentClientName = decodedClient;
        document.getElementById('client-name').textContent = decodedClient.toUpperCase();
        await cloudStorage.setItem('currentAuditClient', decodedClient);
        
        const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
        const currentClient = allClients.find(c => c.company.toUpperCase() === decodedClient.toUpperCase());
        
        if(currentClient) {
            if(currentClient.speedLimit) document.getElementById('master-speed').value = currentClient.speedLimit;
            if(currentClient.fuelPrice) {
                document.getElementById('price-w').value = currentClient.fuelPrice;
                document.getElementById('price-r').value = parseFloat(currentClient.fuelPrice) + 2.35;
            }
            if(currentClient.targetCons) document.getElementById('master-target').value = currentClient.targetCons;
            loadAuditDraft(decodedClient);
        }
    } else {
        const savedCompany = await cloudStorage.getItem('currentAuditClient');
        if(savedCompany) {
            currentClientName = savedCompany;
            document.getElementById('client-name').textContent = savedCompany.toUpperCase();
            loadAuditDraft(savedCompany);
        } else {
            // No client in URL or await cloudStorage - check if there are any drafts
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const clientsWithDrafts = allClients.filter(c => {
                const draftKey = 'AUDIT_DRAFT_' + c.company.toUpperCase().replace(/\s+/g, '_');
                return await cloudStorage.getItem(draftKey) !== null;
            });
            
            if (clientsWithDrafts.length > 0) {
                // Use the most recent one
                currentClientName = clientsWithDrafts[0].company;
                document.getElementById('client-name').textContent = currentClientName.toUpperCase();
                await cloudStorage.setItem('currentAuditClient', currentClientName);
                loadAuditDraft(currentClientName);
            }
        }
    }
    
    console.log('Current client:', currentClientName); // Debug line
}
            
        async function loadAuditDraft(clientName) {
            const draftKey = 'AUDIT_DRAFT_' + clientName.toUpperCase().replace(/\s+/g, '_');
            const savedDraft = await cloudStorage.getItem(draftKey);
            
            if(savedDraft) {
                try {
                    const draft = JSON.parse(savedDraft);
                    auditData = draft.auditData || {};
			if(Object.keys(auditData).length > 0) {
                       document.getElementById('stat-usage').innerText = '‚úì';
                       document.getElementById('stat-usage').classList.replace('text-red-500', 'text-emerald-500');
                       document.getElementById('stat-speed').innerText = '‚úì';
                       document.getElementById('stat-speed').classList.replace('text-red-500', 'text-emerald-500');
}

		    if(draft.speedLimit) document.getElementById('master-speed').value = draft.speedLimit;
                    if(draft.priceW) document.getElementById('price-w').value = draft.priceW;
                    if(draft.priceR) document.getElementById('price-r').value = draft.priceR;
                    if(draft.target) document.getElementById('master-target').value = draft.target;
                    if(draft.auditDate) document.getElementById('date-label').innerText = draft.auditDate;
                    if(draft.auditPeriod) document.getElementById('audit-period').innerText = draft.auditPeriod;
                    
                    if(Object.keys(auditData).length > 0) {
                        renderGrid();
                        showDraftStatus('Draft Loaded - ' + new Date(draft.savedAt).toLocaleString());
                    }
                } catch(e) {
                    console.error('Error loading draft:', e);
                }
            }
	}

     async function autoSaveAuditDraft() {
    if(!currentClientName) return;
    
    const draftKey = 'AUDIT_DRAFT_' + currentClientName.toUpperCase().replace(/\s+/g, '_');
    const draft = {
        auditData: auditData,
        speedLimit: document.getElementById('master-speed').value,
        priceW: document.getElementById('price-w').value,
        priceR: document.getElementById('price-r').value,
        target: document.getElementById('master-target').value,
        auditDate: document.getElementById('date-label').innerText,
        auditPeriod: document.getElementById('audit-period').innerText,  
        savedAt: new Date().toISOString()
		
    };
    
    await cloudStorage.setItem(draftKey, JSON.stringify(draft));
    
    // Only set to in-progress if not already complete
    let allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const clientIndex = allClients.findIndex(c => c.company.toUpperCase() === currentClientName.toUpperCase());
    if(clientIndex === -1 || allClients[clientIndex].auditStatus !== 'complete') {
        updateClientAuditStatus('in-progress');
    }
    showDraftStatus('Draft Auto-Saved');
}

        function showDraftStatus(message) {
            const statusEl = document.getElementById('date-label');
            const originalText = statusEl.innerText;
            statusEl.innerText = 'üíæ ' + message;
            statusEl.style.color = '#10b981';
            setTimeout(() => {
                statusEl.innerText = originalText;
                statusEl.style.color = '';
            }, 2000);
        }

       async function updateClientAuditStatus(status) {
            let allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const clientIndex = allClients.findIndex(c => c.company.toUpperCase() === currentClientName.toUpperCase());
            
            if(clientIndex !== -1) {
                allClients[clientIndex].auditStatus = status;
                allClients[clientIndex].lastEditedDate = new Date().toISOString();
                await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClients));
            }
        }

        function launchMapper(input, mode) {
            if (!input.files || !input.files[0]) return;
            
            activeMode = mode;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const delim = text.includes(';') ? ';' : ',';
                activeRows = text.split(/\r?\n/).filter(l => l.trim()).map(r => r.split(delim));
                
                if (activeRows.length === 0) {
                    alert('CSV file is empty');
                    return;
                }
                
                const headers = activeRows[0];
                const opts = headers.map((h, i) => '<option value="' + i + '">' + h + '</option>').join('');
                
                const mappingKey = 'CSV_MAPPING_' + currentClientName.toUpperCase().replace(/\s+/g, '_') + '_' + mode;
                const savedMapping = await cloudStorage.getItem(mappingKey);
                
                let regIdx = 0, valIdx = 1, dateIdx = -1, durationIdx = -1, maxSpeedIdx = -1;
                
                if (savedMapping) {
                    const mapping = JSON.parse(savedMapping);
                    regIdx = mapping.reg;
                    valIdx = mapping.val;
                    dateIdx = mapping.date;
                    if(mapping.duration !== undefined) durationIdx = mapping.duration;
                    if(mapping.maxSpeed !== undefined) maxSpeedIdx = mapping.maxSpeed;
                } else {
                    headers.forEach((h, i) => {
                        const lower = h.toLowerCase();
                        // Check for registration columns
                        if (lower.includes('reg') || lower.includes('vehicle') || lower.includes('unit') || lower.includes('asset')) regIdx = i;
                        // Check for usage/distance columns
                        if (mode === 'usage' && (lower.includes('km') || lower.includes('distance') || lower.includes('odometer'))) valIdx = i;
                        // Check for speed columns
                        if (mode === 'speed' && (lower.includes('speed') || lower.includes('km/h') || lower.includes('kmh'))) valIdx = i;
                        // Check for date columns
                        if (lower.includes('date') || lower.includes('time')) dateIdx = i;
                        // Check for duration columns (Usage CSV only)
                        if (mode === 'usage' && (lower.includes('over speed duration') || lower.includes('overspeed duration'))) durationIdx = i;
                        // Check for max speed columns (Usage CSV only)
                        if (mode === 'usage' && lower.includes('max speed') && !lower.includes('duration')) maxSpeedIdx = i;
                    });
                }
                document.getElementById('map-reg').innerHTML = opts;
                document.getElementById('map-val').innerHTML = opts;
                document.getElementById('map-date').innerHTML = '<option value="-1">None</option>' + opts;
                
                document.getElementById('map-reg').value = regIdx;
                document.getElementById('map-val').value = valIdx;
                document.getElementById('map-date').value = dateIdx;
                
                if(mode === 'usage') {
                    document.getElementById('usage-extra-fields').style.display = 'block';
                    document.getElementById('map-duration').innerHTML = '<option value="-1">None / Not Available</option>' + opts;
                    document.getElementById('map-maxspeed').innerHTML = '<option value="-1">None</option>' + opts;
                    document.getElementById('map-duration').value = durationIdx;
                    document.getElementById('map-maxspeed').value = maxSpeedIdx;
                } else {
                    document.getElementById('usage-extra-fields').style.display = 'none';
                }
                
                document.getElementById('logic-selector-box').style.display = (mode === 'usage') ? 'block' : 'none';
                document.getElementById('mapper-modal').style.display = 'flex';
            };
            reader.readAsText(input.files[0]);
        }

    async function commitMapping() {
    // Prevent duplicate processing within 2 seconds
    const now = Date.now();
    if (now - lastUploadTimestamp[activeMode] < 2000) {
        console.log('Ignoring duplicate upload attempt for ' + activeMode);
        return;
    }
    lastUploadTimestamp[activeMode] = now;
    
    const rIdx = parseInt(document.getElementById('map-reg').value);
    const vIdx = parseInt(document.getElementById('map-val').value);
    const dIdx = parseInt(document.getElementById('map-date').value);
    const logic = document.getElementById('map-logic') ? document.getElementById('map-logic').value : 'sum';
    
    let durIdx = -1, maxSpdIdx = -1;
    if(activeMode === 'usage') {
        durIdx = parseInt(document.getElementById('map-duration').value);
        maxSpdIdx = parseInt(document.getElementById('map-maxspeed').value);
    }

    const mappingKey = 'CSV_MAPPING_' + currentClientName.toUpperCase().replace(/\s+/g, '_') + '_' + activeMode;
    await cloudStorage.setItem(mappingKey, JSON.stringify({ 
        reg: rIdx, 
        val: vIdx, 
        date: dIdx, 
        logic: logic,
        duration: durIdx,
        maxSpeed: maxSpdIdx
    }));

    const currentMapping = { reg: rIdx, val: vIdx, date: dIdx, duration: durIdx, maxSpeed: maxSpdIdx };

    // Create fresh data for this upload - preserves manual entries but resets CSV data
    let newData = {};
    
  // Copy existing data - COMPLETELY reset CSV fields when re-uploading
Object.keys(auditData).forEach(k => {
    newData[k] = {
        reg: auditData[k].reg,
        type: auditData[k].type || 'Heavy',
        make: auditData[k].make || '',
        model: auditData[k].model || '',
        year: auditData[k].year || '',
        usedFor: auditData[k].usedFor || 'Long Distance',
        targetKmL: auditData[k].targetKmL || '2.3',
        gps: 0,  // Always reset to 0 - will be recalculated from CSV
        odo: auditData[k].odo || '',  // Keep manual entry
        liters: auditData[k].liters || '',  // Keep manual entry
        speeds: [],  // Always reset to empty - will be repopulated from CSV
        duration: 0,  // Always reset
        maxSpeed: 0  // Always reset
    };
});

    let processedCount = 0;
    let firstDate = null;
    let lastDate = null;

    // Process each row from CSV
    activeRows.slice(1).forEach(row => {
        if(!row[currentMapping.reg]) return;
        const key = row[currentMapping.reg].trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(-7);
        
        // Parse date if available
        if(dIdx !== -1 && row[currentMapping.date]) {
            const dateStr = row[currentMapping.date].trim();
            const datePart = dateStr.split(' ')[0].split('T')[0];
            
            let dateObj;
            
            if(datePart.includes('/')) {
                const parts = datePart.split('/');
                if(parts[0].length === 4) {
                    dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else if(datePart.includes('-')) {
                const parts = datePart.split('-');
                if(parts[0].length === 4) {
                    dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else {
                dateObj = new Date(datePart);
            }
            
            if(!isNaN(dateObj)) {
                if(!firstDate || dateObj < firstDate) firstDate = dateObj;
                if(!lastDate || dateObj > lastDate) lastDate = dateObj;
            }
        }

        // Initialize vehicle if new
        if(!newData[key]) {
            newData[key] = { 
                reg: row[currentMapping.reg].trim(), 
                type: auditData[key]?.type || 'Heavy',
                make: auditData[key]?.make || '',
                model: auditData[key]?.model || '',
                year: auditData[key]?.year || '',
                usedFor: auditData[key]?.usedFor || 'Long Distance',
                targetKmL: auditData[key]?.targetKmL || '2.3',
                gps: 0, 
                odo: auditData[key]?.odo || '',
                liters: auditData[key]?.liters || '',
                speeds: [], 
                duration: 0, 
                maxSpeed: 0 
            };
        }
        
        const val = parseFloat(row[currentMapping.val]) || 0;
        
        if(activeMode === 'usage') {
            if (logic === 'sum') {
                newData[key].gps += val;
            } else {
                if (val > newData[key].gps) newData[key].gps = val;
            }
            
            // Capture duration and max speed
            if(currentMapping.duration >= 0 && row[currentMapping.duration]) {
                const durVal = parseFloat(row[currentMapping.duration]) || 0;
                newData[key].duration += durVal;
            }
            if(currentMapping.maxSpeed >= 0 && row[currentMapping.maxSpeed]) {
                const spdVal = parseFloat(row[currentMapping.maxSpeed]) || 0;
                if(spdVal > newData[key].maxSpeed) newData[key].maxSpeed = spdVal;
            }
            
            processedCount++;
        } else if(activeMode === 'speed') {
            newData[key].speeds.push(val);
            processedCount++;
        }
    });

    // Replace auditData with newData (fresh data, no accumulation)
    auditData = newData;

    // Set audit period
    if(firstDate && lastDate) {
        const formatDate = (date) => {
            const day = String(date.getDate()).padStart(2, '0');
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        };
        
        const fromDate = formatDate(firstDate);
        const toDate = formatDate(lastDate);
        
        if(fromDate === toDate) {
            document.getElementById('audit-period').innerText = fromDate;
        } else {
            document.getElementById('audit-period').innerText = fromDate + " - " + toDate;
        }
        document.getElementById('date-label').innerText = "DRAFT AUTO-SAVED";
    }

    console.log(activeMode + ' CSV processed: ' + processedCount + ' rows');
    document.getElementById('stat-' + activeMode).innerText = '‚úì';
    document.getElementById('stat-' + activeMode).classList.replace('text-red-500', 'text-emerald-500');
    document.getElementById('mapper-modal').style.display = 'none';

    // Clear file input
    if(activeMode === 'usage') {
        document.getElementById('csv-usage').value = '';
    } else {
        document.getElementById('csv-speed').value = '';
    }

    autoSaveAuditDraft();

    // Redirect to manual entry if both CSVs uploaded
    setTimeout(() => {
        const usageDone = document.getElementById('stat-usage').innerText === '‚úì';
        const speedDone = document.getElementById('stat-speed').innerText === '‚úì';

        if (usageDone && speedDone) {
            window.location.href = 'data-entry.html?client=' + encodeURIComponent(currentClientName);
        } else {
            renderGrid();
        }
    }, 100);
}

     function renderGrid() {
    const container = document.getElementById('grid-rows');
    container.innerHTML = '';
    const wPrice = parseFloat(document.getElementById('price-w').value) || 0;
    const rPrice = parseFloat(document.getElementById('price-r').value) || 0;
    const globalTarget = parseFloat(document.getElementById('master-target').value) || 2.3;
    const limit = parseFloat(document.getElementById('master-speed').value) || 80;

    let sEffW = 0, sSpeedW = 0, sEffR = 0, sSpeedR = 0;
    let eliteCount = 0, highCount = 0, goodCount = 0, poorCount = 0;
    let totalBonusSavings = 0;

    Object.keys(auditData).forEach(k => {
        const v = auditData[k];
        const odoVal = parseFloat(v.odo) || 0;
        const manualL = parseFloat(v.liters) || 0;
        const target = parseFloat(v.targetKmL) || globalTarget;
        const actKmL = (manualL > 0 && odoVal > 0) ? (odoVal / manualL) : 0;
        const wastedL = (manualL > 0 && odoVal > 0 && actKmL < target) ? (manualL - (odoVal / target)) : 0;
        const drift = odoVal > 0 ? (odoVal - v.gps) : 0;
        
        const events = v.speeds ? v.speeds.filter(s => s > limit).length : 0;
        const penalty = (v.type === 'Heavy' ? 1.5 : 1.1);
        
        let speedLoss = 0;
        
       // Calculate cost per individual speed event
if(v.speeds && v.speeds.length > 0) {
    v.speeds.forEach(speed => {
        if(speed > limit) {
            const speedOver = speed - limit;
            
            // Estimate fuel waste per event based on speed over limit
            // Assume each event is ~5 minutes duration
            const eventDurationHours = 5 / 60; // 5 minutes
            const eventSpeed = speed * 0.9; // Average 90% of recorded speed
            const eventDistance = eventSpeed * eventDurationHours;
            
            // Fuel penalty increases with speed
            const speedPenaltyFactor = 1 + (speedOver / 100); // 1% per km/h over
            const baseRate = 1 / target;
            const normalFuel = eventDistance * baseRate;
            const actualFuel = normalFuel * speedPenaltyFactor;
            const wastedFuel = actualFuel - normalFuel;
            
            speedLoss += wastedFuel * wPrice;
        }
    });
} else {
    // Fallback if no individual speeds available
    speedLoss = events * penalty * wPrice;
}
        
        let score = 100;
        
        if(actKmL > 0 && actKmL < target) {
            const efficiencyDeficit = ((target - actKmL) / target) * 100;
            const efficiencyPenalty = Math.min(40, (efficiencyDeficit / 100) * 40);
            score -= efficiencyPenalty;
        }
        
        if(events > 0) {
            const speedPenalty = Math.min(30, events * 0.3);
            score -= speedPenalty;
        }
        
      // Only penalize duration if ACTUAL max speed from violations is over threshold
const actualMaxSpeed = (v.speeds && v.speeds.length > 0) ? Math.max(...v.speeds) : v.maxSpeed;
if(v.duration > 300 && actualMaxSpeed > limit + 1) {
    const durationMinutes = v.duration / 60;
    const durationPenalty = Math.min(20, (durationMinutes / 30) * 20);
    score -= durationPenalty;
}
        
        if(v.maxSpeed > limit + 20) {
            const extremeSpeedOver = v.maxSpeed - (limit + 20);
            const extremePenalty = Math.min(10, extremeSpeedOver * 0.5);
            score -= extremePenalty;
        }
        
        score = Math.max(0, Math.min(100, Math.round(score)));
        
        const effLoss = wastedL * wPrice;
        const totalLoss = effLoss + speedLoss;
        
        sEffW += effLoss; 
        sSpeedW += speedLoss;
        sEffR += (wastedL * rPrice); 
        sSpeedR += (events * penalty * rPrice);
        
        if(score >= 95) {
            eliteCount++;
            totalBonusSavings += totalLoss;
        } else if(score >= 90) {
            highCount++;
            totalBonusSavings += totalLoss;
        } else if(score >= 80) {
            goodCount++;
            totalBonusSavings += totalLoss;
        } else {
            poorCount++;
        }

        container.innerHTML += `
            <div class="vehicle-row">
                <div class="col-reg font-medium text-[12px] truncate">${v.reg}</div>
                <div class="col-type">
                    <select onchange="auditData['${k}'].type=this.value; renderGrid(); autoSaveAuditDraft();" class="manual-input">
                        <option value="Heavy"${v.type==='Heavy'?' selected':''}>Heavy</option>
                        <option value="Medium"${v.type==='Medium'?' selected':''}>Medium</option>
                    </select>
                </div>
                <div class="col-data text-[11px] opacity-40">${v.gps.toFixed(0)}</div>
                <div class="col-data">
                   <input type="number" placeholder="km" value="${v.odo || ''}" 
           data-key="${k}" data-field="odo"
           onchange="auditData['${k}'].odo=this.value; renderGrid(); autoSaveAuditDraft();" 
           class="manual-input">
                </div>
                <div class="col-drift text-[11px] ${Math.abs(drift) > 50 ? 'text-red-400 font-bold' : 'text-slate-500'}">
                    ${drift.toFixed(0)}
                </div>
                <div class="col-money text-orange-400">R ${effLoss.toFixed(0)}</div>
                <div class="col-data">
                    <input type="number" placeholder="L" value="${v.liters || ''}" 
           data-key="${k}" data-field="liters"
           onchange="auditData['${k}'].liters=this.value; renderGrid(); autoSaveAuditDraft();" 
           class="manual-input">
                </div>
                <div class="col-perf text-[12px] text-orange-400">${wastedL.toFixed(0)} L</div>
                <div class="col-perf text-[12px] font-black ${actKmL < target ? 'text-red-400' : 'text-emerald-400'}">
                    ${actKmL > 0 ? actKmL.toFixed(2) : '-'}
                </div>
                <div class="col-events text-[12px] ${events > 0 ? 'text-red-500 font-bold' : 'text-slate-500'}">
                    ${events}
                </div>
                <div class="col-money text-orange-500 font-bold">R ${speedLoss.toFixed(0)}</div>
                <div class="col-money text-red-500 font-black">R ${totalLoss.toFixed(0)}</div>
                <div class="col-score text-[12px] ${score < 70 ? 'text-red-500' : score < 80 ? 'text-orange-400' : score < 90 ? 'text-blue-400' : score < 95 ? 'text-emerald-400' : 'text-yellow-400'}">
                    ${actKmL > 0 ? score.toFixed(0) + '%' : '-'}${score >= 95 ? ' üèÜ' : score >= 90 ? ' ‚≠ê' : ''}
                </div>
            </div>
        `;
    });

    document.getElementById('l1-eff').innerText = 'R ' + sEffW.toLocaleString();
    document.getElementById('l1-speed').innerText = 'R ' + sSpeedW.toLocaleString();
    document.getElementById('l1-total').innerText = 'R ' + (sEffW + sSpeedW).toLocaleString();
    document.getElementById('l2-eff').innerText = 'R ' + sEffR.toLocaleString();
    document.getElementById('l2-speed').innerText = 'R ' + sSpeedR.toLocaleString();
    document.getElementById('l2-total').innerText = 'R ' + (sEffR + sSpeedR).toLocaleString();
    
    document.getElementById('bonus-elite-count').innerText = eliteCount;
    document.getElementById('bonus-high-count').innerText = highCount;
    document.getElementById('bonus-good-count').innerText = goodCount;
    document.getElementById('bonus-poor-count').innerText = poorCount;
    
    const totalBonus = (eliteCount * 500) + (highCount * 300) + (goodCount * 150);
    const netROI = totalBonusSavings - totalBonus;
    
    document.getElementById('bonus-total').innerText = 'R ' + totalBonus.toLocaleString();
    document.getElementById('bonus-savings').innerText = 'R ' + Math.round(totalBonusSavings).toLocaleString();
    document.getElementById('bonus-roi').innerText = 'R ' + Math.round(netROI).toLocaleString();
    
    if(Object.keys(auditData).length > 0) {
        autoSaveAuditDraft();
    }
}

     async function saveAuditResults() {
    const companyName = await cloudStorage.getItem('currentAuditClient');
    if(!companyName) {
        alert('No client selected for this audit');
        return;
    }

    const wPrice = parseFloat(document.getElementById('price-w').value) || 0;
    const rPrice = parseFloat(document.getElementById('price-r').value) || 0;
    const target = parseFloat(document.getElementById('master-target').value) || 2.3;
    const limit = parseFloat(document.getElementById('master-speed').value) || 80;

    let sEffW = 0, sSpeedW = 0, sEffR = 0, sSpeedR = 0;
    let actualFleetSize = Object.keys(auditData).length;
    
    // ‚úÖ NEW: Array to store per-vehicle breakdown
    let vehicleBreakdown = [];

    Object.keys(auditData).forEach(k => {
        const v = auditData[k];
        const odoVal = parseFloat(v.odo) || 0;
        const manualL = parseFloat(v.liters) || 0;
        const targetKmL = parseFloat(v.targetKmL) || target;
        const actKmL = (manualL > 0 && odoVal > 0) ? (odoVal / manualL) : 0;
        const wastedL = (manualL > 0 && odoVal > 0 && actKmL < targetKmL) ? (manualL - (odoVal / targetKmL)) : 0;
        const events = v.speeds ? v.speeds.filter(s => s > limit).length : 0;
        const penalty = (v.type === 'Heavy' ? 1.5 : 1.1);
        
        let speedLoss = 0;
        
        // Calculate cost per individual speed event (SAME AS RENDERGRID)
        if(v.speeds && v.speeds.length > 0) {
            v.speeds.forEach(speed => {
                if(speed > limit) {
                    const speedOver = speed - limit;
                    const eventDurationHours = 5 / 60; // 5 minutes
                    const eventSpeed = speed * 0.9; // Average 90% of recorded speed
                    const eventDistance = eventSpeed * eventDurationHours;
                    const speedPenaltyFactor = 1 + (speedOver / 100); // 1% per km/h over
                    const baseRate = 1 / targetKmL;
                    const normalFuel = eventDistance * baseRate;
                    const actualFuel = normalFuel * speedPenaltyFactor;
                    const wastedFuel = actualFuel - normalFuel;
                    speedLoss += wastedFuel * wPrice;
                }
            });
        } else {
            // Fallback if no individual speeds available
            speedLoss = events * penalty * wPrice;
        }
        
        const effLoss = wastedL * wPrice;
        const tLoss = effLoss + speedLoss;
        
        // ‚úÖ NEW: Store per-vehicle losses
        vehicleBreakdown.push({
            reg: v.reg,
            eLoss: effLoss,
            sLoss: speedLoss,
            tLoss: tLoss
        });
        
        sEffW += effLoss; 
        sSpeedW += speedLoss;
        sEffR += (wastedL * rPrice); 
        sSpeedR += (speedLoss / wPrice) * rPrice;
    });

    let allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const clientIndex = allClients.findIndex(c => c.company.toUpperCase() === companyName.toUpperCase());
    
    if(clientIndex !== -1) { 
        allClients[clientIndex].fleetSize = actualFleetSize;
        allClients[clientIndex].fleetSizeConfirmed = true;
        allClients[clientIndex].speedLimit = limit;
        allClients[clientIndex].fuelPrice = wPrice;
        allClients[clientIndex].targetCons = target;
        allClients[clientIndex].lastAuditDate = new Date().toLocaleDateString();
        allClients[clientIndex].auditStatus = 'complete';
        
        // Get the displayed totals from the UI instead of recalculating
        const displayedEffW = parseFloat(document.getElementById('l1-eff').innerText.replace('R', '').replace(/,/g, '').trim());
        const displayedSpeedW = parseFloat(document.getElementById('l1-speed').innerText.replace('R', '').replace(/,/g, '').trim());
        const displayedTotalW = parseFloat(document.getElementById('l1-total').innerText.replace('R', '').replace(/,/g, '').trim());

        allClients[clientIndex].auditResults = {
            totalKM: Math.round(Object.keys(auditData).reduce((sum, k) => sum + (parseFloat(auditData[k].odo) || 0), 0)),
            totalLiters: Math.round(Object.keys(auditData).reduce((sum, k) => sum + (parseFloat(auditData[k].liters) || 0), 0)),
            fleetEfficiency: "84%",
            wholesaleEffLoss: Math.round(displayedEffW),
            wholesaleSpeedLoss: Math.round(displayedSpeedW),
            wholesaleTotalLoss: Math.round(displayedTotalW),
            retailEffLoss: Math.round(sEffR),
            retailSpeedLoss: Math.round(sSpeedR),
            retailTotalLoss: Math.round(sEffR + sSpeedR),
            vehicleCount: actualFleetSize,
            auditDate: new Date().toISOString(),
            vehicles: vehicleBreakdown  // ‚úÖ NEW: Add per-vehicle breakdown
        };

        // Save weekly history - use audit end date, not today's date
        const historyKey = `AUDIT_HISTORY_${allClients[clientIndex].id}`;
        let history = JSON.parse(await cloudStorage.getItem(historyKey)) || [];

        // Get audit end date from the audit period
        const session = JSON.parse(await cloudStorage.getItem('AUDIT_FINAL'));
        const auditPeriod = session?.month || '';
        let auditEndDate = new Date();

        if(auditPeriod.includes(' - ')) {
            const endDateStr = auditPeriod.split(' - ')[1].trim();
            const parts = endDateStr.split(' ');
            if(parts.length === 3) {
                const monthMap = {JAN:0, FEB:1, MAR:2, APR:3, MAY:4, JUN:5, JUL:6, AUG:7, SEP:8, OCT:9, NOV:10, DEC:11};
                auditEndDate = new Date(parseInt(parts[2]), monthMap[parts[1]], parseInt(parts[0]));
            }
        }

        const weekLabel = auditEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Check if this week already exists (prevent duplicates)
        const existingIndex = history.findIndex(h => h.week === weekLabel);

        const newEntry = {
            week: weekLabel,
            date: auditEndDate.toISOString(),
            fuelLoss: Math.round(displayedTotalW),
            distance: Math.round(Object.keys(auditData).reduce((sum, k) => sum + (parseFloat(auditData[k].odo) || 0), 0)),
            fuelConsumed: Math.round(Object.keys(auditData).reduce((sum, k) => sum + (parseFloat(auditData[k].liters) || 0), 0))
        };

        if(existingIndex >= 0) {
            // Update existing entry
            history[existingIndex] = newEntry;
        } else {
            // Add new entry
            history.push(newEntry);
        }

        await cloudStorage.setItem(historyKey, JSON.stringify(history));
        await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClients));
        autoSaveAuditDraft();
        
        alert('‚úÖ Audit Complete!\n\nActual Fleet Size: ' + actualFleetSize + ' vehicles\nTotal Wholesale Loss: R ' + (sEffW + sSpeedW).toLocaleString() + '\nTotal Retail Loss: R ' + (sEffR + sSpeedR).toLocaleString() + '\n\nClient record updated. You can now convert to Active or run another audit.');
    } else {
        alert('‚ùå Client not found in system');
    }
}

      function generateReport() {
    const companyName = currentClientName || "Unknown Client";
    const fleetSize = Object.keys(auditData).length;
    
    if (fleetSize === 0) {
        alert('‚ö†Ô∏è No audit data to generate report. Please upload CSV files first.');
        return;
    }
    
    const auditDateLabel = document.getElementById('audit-period').innerText.replace("AUDIT DATE: ", "");
    const target = parseFloat(document.getElementById('master-target').value) || 2.3;
    const limit = parseFloat(document.getElementById('master-speed').value) || 80;
    
    // Transform auditData into the format report-final.html expects
    const fleet = Object.keys(auditData).map(k => {
        const v = auditData[k];
        const odoVal = parseFloat(v.odo) || 0;
        const manualL = parseFloat(v.liters) || 0;
        const events = v.speeds ? v.speeds.filter(s => s > limit).length : 0;
        const penalty = (v.type === 'Heavy' ? 1.5 : 1.1);
        
        // Calculate speed waste using hybrid approach if duration available
        let speedWasteL = 0;
        if(v.duration > 0 && v.maxSpeed > limit) {
            const durationHours = v.duration / 3600;
            const speedOver = v.maxSpeed - limit;
            const speedFactor = 1 + Math.pow(speedOver / 20, 1.6);
            const baseRate = 1 / target;
            const avgSpeedDuringViolation = v.maxSpeed * 0.85;
            const distanceAtSpeed = avgSpeedDuringViolation * durationHours;
            speedWasteL = baseRate * (speedFactor - 1) * distanceAtSpeed;
        } else {
            speedWasteL = events * penalty;
        }
        
        return {
            reg: v.reg,
            type: v.type,
            gpsDist: v.gps,
            mK: odoVal,
            mL: manualL,
            violations: events,
            speedWasteL: speedWasteL,
            duration: v.duration || 0,
            maxSpeed: v.maxSpeed || 0
        };
    });
    
    // Get client info and status
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const currentClient = allClients.find(c => c.company.toUpperCase() === companyName.toUpperCase());
    const clientTown = currentClient?.city || "Cape Town";
    const isActive = currentClient?.status === 'active' || false;
    
    // Prepare the payload in the exact format report-final.html expects
    const reportPayload = {
        client: {
            company: companyName,
            town: clientTown,
            target: target
        },
        month: auditDateLabel,
        fleet: fleet,
        speedLimit: limit,
        isActive: isActive
    };
    
    // Save to await cloudStorage so report-final.html can read it
    await cloudStorage.setItem('AUDIT_FINAL', JSON.stringify(reportPayload));
    console.log('üìä Report data saved to await cloudStorage:', reportPayload);
    console.log('üîë Client status:', isActive ? 'ACTIVE' : 'PROSPECT');
    
    // Try to open the report in a new tab
    const reportWindow = window.open('report-final.html', '_blank');
    
    // Check if pop-up was blocked
    if (!reportWindow || reportWindow.closed || typeof reportWindow.closed == 'undefined') {
        alert('‚ö†Ô∏è Pop-up blocked! Please allow pop-ups for this site, then try again.\n\nOr manually open report-final.html in a new tab.');
    } else {
        console.log('‚úÖ Report opened successfully');
    }
}

setInterval(() => {
    if(Object.keys(auditData).length > 0) {
        const draftKey = 'AUDIT_DRAFT_' + currentClientName.toUpperCase().replace(/\s+/g, '_');
        const draft = {
            auditData: auditData,
            speedLimit: document.getElementById('master-speed').value,
            priceW: document.getElementById('price-w').value,
            priceR: document.getElementById('price-r').value,
            target: document.getElementById('master-target').value,
            auditDate: document.getElementById('date-label').innerText,
            auditPeriod: document.getElementById('audit-period').innerText,
            savedAt: new Date().toISOString()
        };
        await cloudStorage.setItem(draftKey, JSON.stringify(draft));
        
        // Only set to in-progress if not already complete
        let allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
        const clientIndex = allClients.findIndex(c => c.company.toUpperCase() === currentClientName.toUpperCase());
        if(clientIndex !== -1 && allClients[clientIndex].auditStatus !== 'complete') {
            updateClientAuditStatus('in-progress');
        }
    }
}, 30000);

</script>
</body>
</html>


