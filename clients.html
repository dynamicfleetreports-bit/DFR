<!DOCTYPE html>
<html lang="en">
<head>
    <script type="module" src="firebase-helper.js"></script>
    <meta charset="UTF-8">
    <title>Database | Fleet Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #020617; color: white; padding: 3rem; min-height: 100vh; }
        .client-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.5rem; padding: 2rem; cursor: pointer; transition: all 0.3s; position: relative; text-decoration: none; display: block; }
        .client-card:hover { transform: translateY(-5px); border-color: #10b981; box-shadow: 0 20px 40px -10px rgba(16, 185, 129, 0.3); }
        .company-name { font-size: 1.5rem; font-weight: 900; text-transform: uppercase; color: white; letter-spacing: -0.02em; }
        .client-meta { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.4); margin-top: 0.5rem; }
        .backup-buttons { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .btn-backup { background: #6366f1; color: white; padding: 1rem 2rem; border-radius: 1rem; font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 0.1em; cursor: pointer; border: none; transition: all 0.3s; box-shadow: 0 10px 30px -5px rgba(99, 102, 241, 0.4); }
        .btn-backup:hover { background: #4f46e5; transform: translateY(-2px); }
        .btn-restore { background: #10b981; color: white; padding: 1rem 2rem; border-radius: 1rem; font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 0.1em; cursor: pointer; border: none; transition: all 0.3s; box-shadow: 0 10px 30px -5px rgba(16, 185, 129, 0.4); }
        .btn-restore:hover { background: #059669; transform: translateY(-2px); }
        .filter-buttons { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .btn-filter { background: rgba(255,255,255,0.1); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 900; text-transform: uppercase; font-size: 10px; letter-spacing: 0.1em; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s; }
        .btn-filter:hover { background: rgba(255,255,255,0.2); }
        .btn-filter.active { background: #10b981; border-color: #10b981; }
        #restoreInput { display: none; }
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; margin-left: 1rem; }
        .badge-prospect { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .badge-active { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-end mb-8">
            <div>
                <button onclick="window.location.href='index.html'" class="text-white/30 hover:text-white font-black text-[10px] uppercase tracking-[0.4em] mb-4 transition-all block">‚Üê Hub</button>
                <h1 id="pageTitle" class="text-6xl font-black italic uppercase tracking-tighter leading-none">All <span class="text-emerald-400">Clients</span></h1>
                <p id="clientCount" class="text-emerald-400/60 text-sm font-bold mt-2 uppercase tracking-wider">Loading...</p>
            </div>
            <button onclick="window.location.href='create.html'" class="bg-emerald-500 hover:bg-emerald-400 text-white px-10 py-5 rounded-2xl font-black text-xs uppercase tracking-widest transition-all shadow-2xl">+ New Intake</button>
        </header>

        <!-- FILTER BUTTONS -->
        <div class="filter-buttons">
            <button onclick="filterClients('all')" id="filterAll" class="btn-filter active">All Clients</button>
            <button onclick="filterClients('prospect')" id="filterProspect" class="btn-filter">Prospects</button>
            <button onclick="filterClients('active')" id="filterActive" class="btn-filter">Active</button>
        </div>

        <!-- BACKUP & RESTORE BUTTONS -->
        <div class="backup-buttons">
            <button onclick="backupAllClients()" class="btn-backup">üíæ Backup to Google Drive</button>
            <button onclick="restoreFromGoogleDrive()" class="btn-restore">üîÑ Restore from Google Drive</button>
            <button onclick="document.getElementById('restoreInput').click()" class="btn-restore" style="background: #6366f1;">üìÅ Restore from File</button>
            <input type="file" id="restoreInput" accept=".json" onchange="restoreFromFile(event)">
        </div>

        <div id="clientContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let allClientsData = [];

        // BACKUP FUNCTION - Save all clients to Google Drive
async function backupAllClients() {
    try {
        // Load all clients
        const data = await cloudStorage.getItem('FLEET_CLIENTS');
        const allClients = JSON.parse(data || '[]');

        if (allClients.length === 0) {
            alert('‚ö†Ô∏è No clients to backup!\n\nPlease add some clients first.');
            return;
        }

        // Prepare backup containers
        const auditsData = {};
        const historyData = {};
        let totalVehicles = 0;

        // Loop through each client
        for (const client of allClients) {
            const auditKey = `AUDIT_FINAL_${client.id}`;
            const historyKey = `AUDIT_HISTORY_${client.id}`;

            const audit = await cloudStorage.getItem(auditKey);
            const history = await cloudStorage.getItem(historyKey);

            if (audit) auditsData[client.id] = JSON.parse(audit);
            if (history) historyData[client.id] = JSON.parse(history);

            // Count vehicles
            if (client.fleet && Array.isArray(client.fleet)) {
                totalVehicles += client.fleet.length;
            }
        }

        // Build final backup object
        const backupData = {
            timestamp: new Date().toISOString(),
            totalClients: allClients.length,
            prospects: allClients.filter(c => c.status === 'prospect').length,
            active: allClients.filter(c => c.status === 'active').length,
            totalVehicles: totalVehicles,
            clients: allClients,
            audits: auditsData,
            history: historyData,
            version: '1.1',
            appName: 'Fleet Intelligence System'
        };

        // Send to Google Apps Script
        const response = await fetch(
            'https://script.google.com/macros/s/AKfycbwuWyGboNTuisBBVLWMJpFZchPaCqUnCd8cE92UzFJ3PIzMPzw1-Zzvv1CfM1sWlVVi/exec',
            {
                method: 'POST',
                body: JSON.stringify({
                    action: 'backup',
                    data: backupData
                })
            }
        );

        const result = await response.json();

        // Handle result
        if (result.success) {
            alert(
                `‚úÖ Backup Complete!\n\n` +
                `üìä Total Clients: ${backupData.totalClients}\n` +
                `üü° Prospects: ${backupData.prospects}\n` +
                `üü¢ Active: ${backupData.active}\n` +
                `üöõ Total Vehicles: ${backupData.totalVehicles}\n\n` +
                `File saved to Google Drive:\n${result.fileName}`
            );
        } else {
            alert('‚ùå Backup failed: ' + result.error);
        }

    } catch (err) {
        alert('‚ùå Backup error: ' + err.message);
        console.error('Backup error:', err);
    }
}





        // RESTORE FUNCTION - Get latest backup from Google Drive
        async function restoreFromGoogleDrive() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwuWyGboNTuisBBVLWMJpFZchPaCqUnCd8cE92UzFJ3PIzMPzw1-Zzvv1CfM1sWlVVi/exec?action=restore');
                
                const result = await response.json();

                if (result.success && result.latestBackup) {
                    const backupData = result.latestBackup.data;
                    
                    const confirmMsg = `üîÑ Restore Backup from Google Drive?\n\n` +
                        `üìÖ Created: ${new Date(result.latestBackup.date).toLocaleString()}\n` +
                        `üìä Total Clients: ${backupData.totalClients}\n` +
                        `üü° Prospects: ${backupData.prospects}\n` +
                        `üü¢ Active: ${backupData.active}\n\n` +
                        `‚ö†Ô∏è WARNING: This will replace all current client data!\n\n` +
                        `Continue?`;

                    if (confirm(confirmMsg)) {
                        // Restore clients
                        await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(backupData.clients));
                        
                        // Restore audit data
                        if (backupData.audits) {
                            Object.keys(backupData.audits).forEach(clientId => {
                                await cloudStorage.setItem(`AUDIT_FINAL_${clientId}`, JSON.stringify(backupData.audits[clientId]));
                            });
                        }
                        
                        // Restore history data
                        if (backupData.history) {
                            Object.keys(backupData.history).forEach(clientId => {
                                await cloudStorage.setItem(`AUDIT_HISTORY_${clientId}`, JSON.stringify(backupData.history[clientId]));
                            });
                        }
                        
                        alert(`‚úÖ Restore Complete!\n\n${backupData.totalClients} clients restored with full audit data.`);
                        location.reload();
                    }
                } else {
                    alert('‚ùå Restore failed: ' + (result.error || 'No backups found'));
                }
            } catch (err) {
                alert('‚ùå Restore error: ' + err.message);
                console.error('Restore error:', err);
            }
        }

        // Keep the file upload restore as backup option
       async function restoreFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.clients || !Array.isArray(backupData.clients)) {
                        alert('‚ùå Invalid backup file!');
                        return;
                    }

                    const confirmMsg = `üîÑ Restore Backup from File?\n\n` +
                        `üìÖ Created: ${new Date(backupData.timestamp).toLocaleString()}\n` +
                        `üìä Total Clients: ${backupData.totalClients}\n\n` +
                        `Continue?`;

                    if (confirm(confirmMsg)) {
                        await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(backupData.clients));
                        
                        // Restore audit data if available
                        if (backupData.audits) {
                            Object.keys(backupData.audits).forEach(clientId => {
                                await cloudStorage.setItem(`AUDIT_FINAL_${clientId}`, JSON.stringify(backupData.audits[clientId]));
                            });
                        }
                        
                        // Restore history data if available
                        if (backupData.history) {
                            Object.keys(backupData.history).forEach(clientId => {
                                await cloudStorage.setItem(`AUDIT_HISTORY_${clientId}`, JSON.stringify(backupData.history[clientId]));
                            });
                        }
                        
                        alert(`‚úÖ Restore Complete!\n\n${backupData.totalClients} clients restored.`);
                        location.reload();
                    }
                } catch (err) {
                    alert('‚ùå Restore failed: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function filterClients(filter) {
            currentFilter = filter;
            
            // Update button states
            document.getElementById('filterAll').classList.remove('active');
            document.getElementById('filterProspect').classList.remove('active');
            document.getElementById('filterActive').classList.remove('active');
            
            if (filter === 'all') {
                document.getElementById('filterAll').classList.add('active');
                document.getElementById('pageTitle').innerHTML = 'All <span class="text-emerald-400">Clients</span>';
            } else if (filter === 'prospect') {
                document.getElementById('filterProspect').classList.add('active');
                document.getElementById('pageTitle').innerHTML = 'Prospect <span class="text-emerald-400">Pipeline</span>';
            } else if (filter === 'active') {
                document.getElementById('filterActive').classList.add('active');
                document.getElementById('pageTitle').innerHTML = 'Active <span class="text-emerald-400">Clients</span>';
            }
            
            renderCards(allClientsData, filter);
        }

        async function loadClients() {
            const container = document.getElementById('clientContainer');
            container.innerHTML = '<p class="text-white/20 font-black animate-pulse uppercase tracking-[0.3em]">Loading Clients...</p>';

            // Load from await cloudStorage
            const localData = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS') || '[]');
            allClientsData = localData;
            renderCards(localData, currentFilter);
        }

        function renderCards(data, filter) {
            const container = document.getElementById('clientContainer');
            
            // Filter based on selection
            let filtered = data;
            if (filter === 'prospect') {
                filtered = data.filter(c => c.status === 'prospect');
            } else if (filter === 'active') {
                filtered = data.filter(c => c.status === 'active');
            }
            
            // Update count
            const prospects = data.filter(c => c.status === 'prospect').length;
            const active = data.filter(c => c.status === 'active').length;
            document.getElementById('clientCount').innerText = `Total: ${data.length} | Prospects: ${prospects} | Active: ${active}`;
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="opacity-20 font-black text-2xl uppercase tracking-widest">No Records Found</p>';
                return;
            }

            container.innerHTML = '';
            filtered.forEach(p => {
                const card = document.createElement('a');
                card.href = `dashboard.html?client=${encodeURIComponent(p.company || p.companyname)}`;
                card.className = 'client-card';
                card.innerHTML = `
                    <div class="company-name">${p.companyname || p.company || 'N/A'}</div>
                    <div class="client-meta">
                        <span class="status-badge badge-${p.status}">${p.status}</span>
                        ${p.fleetsize || p.fleetSize ? ` ‚Ä¢ ${p.fleetsize || p.fleetSize} Vehicles` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

       async function deleteClient(id) {
            if(confirm("Permanently delete this forensic record?")) {
                let all = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS') || '[]');
                all = all.filter(c => c.id != id);
                await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(all));
                location.reload();
            }
        }

        window.onload = loadClients;
    </script>
</body>

</html>






