<!DOCTYPE html>
<html lang="en">
<head>
    <script type="module" src="firebase-helper.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Efficiency Audit Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #f1f5f9; color: #0f172a; margin: 0; }
        .report-page { width: 297mm; min-height: 210mm; padding: 5mm; margin: 10mm auto; background: white; box-shadow: 0 10px 50px rgba(0,0,0,0.1); box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #0f172a; color: white; font-size: 9px; text-transform: uppercase; padding: 10px 5px; border: 1px solid #e2e8f0; }
        td { padding: 8px 5px; border: 1px solid #e2e8f0; font-size: 10px; font-weight: 700; text-align: center; }
        .hero-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 1.5rem; border-radius: 1rem; flex: 1; text-align: center; }
        
        @media print {
            @page {
                size: A4 landscape;
                margin: 8mm;
            }
            
            body { 
                background: white !important; 
                margin: 0;
                padding: 0;
            }
            
            .report-page { 
                margin: 0 !important; 
                padding: 0 !important;
                box-shadow: none !important;
                width: 100% !important;
                max-width: 100% !important;
                min-height: auto !important;
            }
            
            .no-print { 
                display: none !important; 
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>

    <!-- Top Control Bar -->
    <div class="no-print bg-slate-900 p-4 flex justify-between items-center text-white sticky top-0 z-50 shadow-lg">
        <div class="font-black italic uppercase tracking-widest text-emerald-400 text-sm">
            <span id="reportType">Forensic Preview Mode</span>
        </div>
        <div class="flex gap-3">
            <button onclick="window.print()" class="bg-emerald-500 text-slate-900 px-6 py-2 rounded-lg font-black text-xs uppercase hover:bg-emerald-400 transition-all shadow-lg">üíæ Save PDF</button>
            <button onclick="emailReport()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-black text-xs uppercase hover:bg-blue-400 transition-all shadow-lg">üìß Email Report</button>
            <button onclick="window.close()" class="bg-slate-700 px-6 py-2 rounded-lg font-black text-xs uppercase hover:bg-slate-600 transition-all">‚úï Close Report</button>
        </div>
    </div>

    <div class="report-page">
        <!-- Header with Logo -->
        <header class="flex justify-between items-start border-b-4 border-emerald-500 pb-6 mb-8">
            <div>
                <img src="Logo.png" alt="Dynamic Fleet Reporting" style="max-width: 180px;" class="mb-4">
                <h1 class="text-5xl font-black uppercase italic tracking-tighter leading-none text-slate-900">
                    FORENSIC FLEET <span class="text-emerald-600">AUDIT</span>
                </h1>
                <p id="repClient" class="text-xl font-bold uppercase text-slate-500 mt-2">CLIENT NAME</p>
            </div>
            <div class="text-right">
                <div class="bg-emerald-600 text-white px-6 py-3 rounded-tl-2xl mb-2">
                    <p class="text-[10px] font-black uppercase opacity-80">Reporting Period</p>
                    <p id="repPeriod" class="text-lg font-black">JAN 2026</p>
                </div>
                <div class="bg-slate-900 text-white px-6 py-3 rounded-bl-2xl mb-2">
                    <p class="text-[10px] font-black uppercase opacity-60">Report Issued</p>
                    <p id="repDate" class="text-lg font-black">01 JAN 2026</p>
                </div>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Confidential</p>
            </div>
        </header>

        <!-- Key Metrics Cards -->
        <div class="flex gap-4 mb-8">
            <div class="hero-card">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Distance</p>
                <h3 id="tileKM" class="text-3xl font-black text-slate-900 italic">-</h3>
            </div>
            <div class="hero-card">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Avg Fleet Score</p>
                <h3 id="tileScore" class="text-3xl font-black text-emerald-500 italic">-</h3>
            </div>
            <div class="hero-card border-l-4 border-l-red-500 bg-red-50">
                <p class="text-[10px] font-black text-red-500 uppercase tracking-widest">Total Savings Opportunity</p>
                <h3 id="tileLoss" class="text-3xl font-black text-red-600 italic">-</h3>
            </div>
        </div>

        <!-- Performance Bonus Section (Active Clients Only) -->
        <div id="bonusSection" style="display:none;" class="mb-8 p-6 bg-gradient-to-r from-yellow-50 to-emerald-50 border-2 border-emerald-500 rounded-2xl">
            <h3 class="text-xl font-black uppercase text-slate-900 mb-4">üèÜ Performance Incentive Program</h3>
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div class="bg-white p-4 rounded-xl border-2 border-yellow-400 text-center">
                    <p class="text-[9px] font-black text-yellow-600 uppercase">Elite Drivers</p>
                    <p id="bonusElite" class="text-3xl font-black text-yellow-600">0</p>
                    <p class="text-[8px] text-slate-500">95-100% ‚Ä¢ R500/mo</p>
                </div>
                <div class="bg-white p-4 rounded-xl border-2 border-emerald-400 text-center">
                    <p class="text-[9px] font-black text-emerald-600 uppercase">High Performers</p>
                    <p id="bonusHigh" class="text-3xl font-black text-emerald-600">0</p>
                    <p class="text-[8px] text-slate-500">90-94% ‚Ä¢ R300/mo</p>
                </div>
                <div class="bg-white p-4 rounded-xl border-2 border-blue-400 text-center">
                    <p class="text-[9px] font-black text-blue-600 uppercase">Good Drivers</p>
                    <p id="bonusGood" class="text-3xl font-black text-blue-600">0</p>
                    <p class="text-[8px] text-slate-500">80-89% ‚Ä¢ R150/mo</p>
                </div>
                <div class="bg-white p-4 rounded-xl border-2 border-red-400 text-center">
                    <p class="text-[9px] font-black text-red-600 uppercase">Needs Training</p>
                    <p id="bonusPoor" class="text-3xl font-black text-red-600">0</p>
                    <p class="text-[8px] text-slate-500">Below 80%</p>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl border border-slate-200">
                    <p class="text-[9px] font-black text-slate-500 uppercase">Monthly Bonus Cost</p>
                    <p id="bonusCost" class="text-xl font-black text-slate-900">R 0</p>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200">
                    <p class="text-[9px] font-black text-slate-500 uppercase">Savings from Top Drivers</p>
                    <p id="bonusSavings" class="text-xl font-black text-emerald-600">R 0</p>
                </div>
                <div class="bg-emerald-600 p-4 rounded-xl text-white">
                    <p class="text-[9px] font-black uppercase opacity-80">Net ROI</p>
                    <p id="bonusROI" class="text-xl font-black">R 0</p>
                </div>
            </div>
        </div>

        <!-- Charts and Top 5 Risk Vehicles -->
        <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="p-6 bg-slate-50 rounded-2xl border border-slate-200">
                <h3 class="text-xs font-black uppercase mb-4 text-slate-400 tracking-widest">Loss Distribution</h3>
                <canvas id="lossChart" height="220"></canvas>
            </div>
            <div class="col-span-2 p-6 bg-slate-50 rounded-2xl border border-slate-200">
                <h3 class="text-xs font-black uppercase mb-4 text-slate-400 tracking-widest italic">Top 5 Critical Risk Vehicles</h3>
                <div id="podium" class="flex flex-col gap-2"></div>
            </div>
        </div>

        <!-- Vehicle Breakdown Table -->
        <table class="mb-8" id="vehicleTable">
            <thead id="tableHeader">
                <!-- Headers will be generated by JS based on client type -->
            </thead>
            <tbody id="repBody"></tbody>
        </table>

        <!-- Vehicle Action Report -->
        <div class="mt-12 p-8 bg-slate-50 border-t-4 border-slate-900 rounded-2xl">
            <h3 class="text-2xl font-black uppercase italic text-slate-900 mb-8 tracking-tight">Vehicle Action Report</h3>
            <div id="actionReport" class="space-y-8"></div>
        </div>

        <!-- Prospect Call-to-Action (Prospects Only) -->
        <div id="prospectCTA" style="display:none;" class="mt-12 p-8 bg-gradient-to-r from-emerald-500 to-blue-500 rounded-2xl text-white">
            <h3 class="text-3xl font-black uppercase mb-4">Ready to Unlock These Savings?</h3>
            <p class="text-lg font-bold mb-6">Partner with Dynamic Fleet Reporting for ongoing monitoring, driver coaching, and continuous optimization.</p>
            <div class="grid grid-cols-3 gap-6">
                <div class="bg-white/10 p-4 rounded-xl backdrop-blur">
                    <p class="text-2xl font-black mb-2">üìä</p>
                    <p class="font-black text-sm">Monthly Reporting</p>
                    <p class="text-xs opacity-80">Track improvements</p>
                </div>
                <div class="bg-white/10 p-4 rounded-xl backdrop-blur">
                    <p class="text-2xl font-black mb-2">üéØ</p>
                    <p class="font-black text-sm">Driver Coaching</p>
                    <p class="text-xs opacity-80">Behavior change programs</p>
                </div>
                <div class="bg-white/10 p-4 rounded-xl backdrop-blur">
                    <p class="text-2xl font-black mb-2">üí∞</p>
                    <p class="font-black text-sm">Guaranteed Savings</p>
                    <p class="text-xs opacity-80">ROI-backed service</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-10 border-t border-slate-200">
            <div class="flex justify-between items-center mb-8">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                    Generated via Master Audit Engine v2.0
                </div>
            </div>
            
            <div class="mt-6 pt-6 border-t-2 border-emerald-500 bg-gradient-to-r from-slate-50 to-emerald-50 -mx-8 -mb-8 px-8 py-6 rounded-b-lg">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="text-lg font-black uppercase text-slate-900 tracking-tight">Dynamic Fleet Reporting</p>
                        <p class="text-[10px] text-slate-600 font-bold mt-1">Professional Fleet Intelligence & Forensic Auditing Services</p>
                    </div>
                    <div class="text-right text-[11px] font-bold text-slate-700">
                        <p class="mb-1">üìû 083 314 9592</p>
                        <p>‚úâÔ∏è <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9efae7f0fff3f7fdf8f2fbfbeaecfbeef1eceaeddef9f3fff7f2b0fdf1f3">[email&#160;protected]</a></p>
                    </div>
                </div>
                <div class="text-center pt-3 border-t border-slate-200">
                    <p class="text-[9px] font-bold text-slate-500 uppercase">Report Generated: <span id="reportCreated" class="text-slate-700">-</span></p>
                </div>
            </div>
        </footer>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
       async function emailReport() {
            const client = document.getElementById('repClient').innerText;
            const subject = encodeURIComponent('Fleet Audit Report - ' + client);
            const body = encodeURIComponent('Please find attached the fleet audit report for ' + client + '.\n\nBest regards,\nDynamic Fleet Reporting');
            window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const raw = await cloudStorage.getItem('AUDIT_FINAL');
            if (!raw) {
                alert('No audit data found. Please generate report from the audit page.');
                return;
            }

            const data = JSON.parse(raw);
            const fleet = Object.values(data.fleet);
            const client = data.client;
            const isActive = data.isActive || false;
            const target = parseFloat(client.target) || 2.3;
            const speedLimit = data.speedLimit || 80;

            // Get saved audit results from FLEET_CLIENTS
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const clientData = allClients.find(c => c.company === client.company);
            
            console.log('Client data:', clientData);
            console.log('Audit results:', clientData?.auditResults);
            console.log('Per-vehicle audit data available:', !!(clientData?.auditResults?.vehicles));

            // Set report type indicator
            document.getElementById('reportType').innerText = isActive ? 'Active Client Report' : 'Prospect Report';

            // Show/hide sections based on client type
            if (isActive) {
                document.getElementById('bonusSection').style.display = 'block';
                document.getElementById('prospectCTA').style.display = 'none';
            } else {
                document.getElementById('bonusSection').style.display = 'none';
                document.getElementById('prospectCTA').style.display = 'block';
            }

            // Header
            document.getElementById('repClient').innerText = client.company;
            document.getElementById('repPeriod').innerText = data.month;
            
            // Report Issue Date
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            document.getElementById('repDate').innerText = dateStr.toUpperCase();
            
            const timeStr = now.toLocaleString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            document.getElementById('reportCreated').innerText = timeStr.toUpperCase();

            // Use SAVED audit results instead of recalculating
            let totalKM = 0;
            let totalLoss = 0;
            let eLossSum = 0;
            let sLossSum = 0;

            if(clientData && clientData.auditResults) {
                const results = clientData.auditResults;
                totalKM = results.totalKM;
                totalLoss = results.wholesaleTotalLoss;
                eLossSum = results.wholesaleEffLoss;
                sLossSum = results.wholesaleSpeedLoss;
                
                console.log('Using saved totals:', { totalKM, totalLoss, eLossSum, sLossSum });
            }

            // Hero Tiles - use saved values
            document.getElementById('tileKM').innerText = Math.round(totalKM).toLocaleString() + " KM";
            document.getElementById('tileLoss').innerText = "R " + Math.round(totalLoss).toLocaleString();

            // Process fleet for table display and scoring ONLY
            let totalScore = 0;
            let eliteCount = 0, highCount = 0, goodCount = 0, poorCount = 0;
            let bonusSavings = 0;

            const processed = fleet.map(v => {
                const km = (v.mK !== null && v.mK !== "" && v.mK > 0) ? parseFloat(v.mK) : v.gpsDist;
                const lit = parseFloat(v.mL) || 0;
                const actEff = (lit > 0 && km > 0) ? (km / lit) : 0;
                const eWaste = (lit > 0 && km > 0 && actEff < target) ? (lit - (km/target)) : 0;
                const events = v.violations || 0;  // Define events outside the if/else block
                
                // Use SAVED per-vehicle losses from audit results if available
                let eLoss = 0;
                let sLoss = 0;
                let tLoss = 0;
                
                if (clientData && clientData.auditResults && clientData.auditResults.vehicles) {
                    const savedVehicle = clientData.auditResults.vehicles.find(sv => sv.reg === v.reg);
                    if (savedVehicle) {
                        eLoss = savedVehicle.eLoss || 0;
                        sLoss = savedVehicle.sLoss || 0;
                        tLoss = savedVehicle.tLoss || 0;
                    }
                } else {
                    // Fallback to recalculation if no saved data
                    const fuelPrice = clientData?.fuelPrice || 21.50;
                    eLoss = eWaste * fuelPrice;
                    const penalty = (v.type === 'Heavy' ? 1.5 : 1.1);
                    sLoss = events * penalty * fuelPrice;
                    tLoss = eLoss + sLoss;
                }

                // Calculate score
                let score = 100;
                
                if(lit > 0 && actEff > 0 && actEff < target) {
                    const efficiencyDeficit = ((target - actEff) / target) * 100;
                    const efficiencyPenalty = Math.min(40, (efficiencyDeficit / 100) * 40);
                    score -= efficiencyPenalty;
                }
                
                if(events > 0) {
                    const speedPenalty = Math.min(30, events * 0.3);
                    score -= speedPenalty;
                }
                
                if(v.duration && v.duration > 300) {
                    const durationMinutes = v.duration / 60;
                    const durationPenalty = Math.min(20, (durationMinutes / 30) * 20);
                    score -= durationPenalty;
                }
                
                if(v.maxSpeed && v.maxSpeed > speedLimit + 20) {
                    const extremeSpeedOver = v.maxSpeed - (speedLimit + 20);
                    const extremePenalty = Math.min(10, extremeSpeedOver * 0.5);
                    score -= extremePenalty;
                }
                
                score = Math.max(0, Math.min(100, Math.round(score)));
                totalScore += score;
                
                // Count performance tiers
                if(score >= 95) {
                    eliteCount++;
                    bonusSavings += tLoss;
                } else if(score >= 90) {
                    highCount++;
                    bonusSavings += tLoss;
                } else if(score >= 80) {
                    goodCount++;
                    bonusSavings += tLoss;
                } else {
                    poorCount++;
                }

                return { ...v, km, lit, actEff, eWaste, eLoss, sLoss, tLoss, score };
            }).sort((a,b) => b.tLoss - a.tLoss);

            // Update avg fleet score
            document.getElementById('tileScore').innerText = Math.round(totalScore / processed.length) + "%";

            // Bonus Section (Active Clients Only)
            if(isActive) {
                document.getElementById('bonusElite').innerText = eliteCount;
                document.getElementById('bonusHigh').innerText = highCount;
                document.getElementById('bonusGood').innerText = goodCount;
                document.getElementById('bonusPoor').innerText = poorCount;
                
                const totalBonus = (eliteCount * 500) + (highCount * 300) + (goodCount * 150);
                const netROI = bonusSavings - totalBonus;
                
                document.getElementById('bonusCost').innerText = 'R ' + totalBonus.toLocaleString();
                document.getElementById('bonusSavings').innerText = 'R ' + Math.round(bonusSavings).toLocaleString();
                document.getElementById('bonusROI').innerText = 'R ' + Math.round(netROI).toLocaleString();
            }

            // Generate Table Headers
            let tableHeaders = '';
            if(isActive) {
                tableHeaders = `
                    <tr>
                        <th class="text-left px-4">Registration</th>
                        <th>Type</th>
                        <th>Track KM</th>
                        <th>Man KM</th>
                        <th>Liters</th>
                        <th class="bg-slate-800">Act KM/L</th>
                        <th>Waste (L)</th>
                        <th>Eff Loss</th>
                        <th>Violations</th>
                        <th>Duration (min)</th>
                        <th>Max Speed</th>
                        <th>Spd Loss</th>
                        <th class="bg-red-900">Total Loss</th>
                        <th>Score</th>
                    </tr>
                `;
            } else {
                tableHeaders = `
                    <tr>
                        <th class="text-left px-4">Registration</th>
                        <th>Track KM</th>
                        <th>Man KM</th>
                        <th>Liters</th>
                        <th class="bg-slate-800">Act KM/L</th>
                        <th>Waste (L)</th>
                        <th>Eff Loss</th>
                        <th>Violations</th>
                        <th>Spd Loss</th>
                        <th class="bg-red-900">Total Loss</th>
                        <th>Score</th>
                    </tr>
                `;
            }
            document.getElementById('tableHeader').innerHTML = tableHeaders;

            // Top 5 Podium
            document.getElementById('podium').innerHTML = processed.slice(0, 5).map((v, i) => `
                <div class="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-xl">
                    <div class="flex items-center gap-4">
                        <span class="bg-red-600 text-white w-7 h-7 rounded-full flex items-center justify-center text-xs font-black">${i+1}</span>
                        <span class="font-black italic text-blue-600 text-sm">${v.reg}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Financial Leakage</p>
                        <p class="text-base font-black text-red-600">R ${Math.round(v.tLoss).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');

            // Table with score indicators
            document.getElementById('repBody').innerHTML = processed.map(v => {
                let scoreClass = 'text-red-600';
                let scoreIcon = '';
                if(v.score >= 95) {
                    scoreClass = 'text-yellow-500';
                    scoreIcon = ' üèÜ';
                } else if(v.score >= 90) {
                    scoreClass = 'text-emerald-600';
                    scoreIcon = ' ‚≠ê';
                } else if(v.score >= 80) {
                    scoreClass = 'text-blue-600';
                } else if(v.score >= 70) {
                    scoreClass = 'text-orange-500';
                }
                
                if(isActive) {
                    return `
                        <tr>
                            <td class="text-left px-4 italic font-black text-blue-600 border-l-4 border-l-blue-500">${v.reg}</td>
                            <td class="text-slate-600 text-[9px]">${v.type || 'Heavy'}</td>
                            <td class="text-slate-400">${v.gpsDist.toFixed(0)}</td>
                            <td>${v.km.toFixed(0)}</td>
                            <td class="text-blue-600">${v.lit > 0 ? v.lit.toFixed(1) : '-'}</td>
                            <td class="${v.actEff > 0 && v.actEff < target ? 'text-red-500' : v.actEff > 0 ? 'text-emerald-600' : ''}">${v.actEff > 0 ? v.actEff.toFixed(2) : '-'}</td>
                            <td>${v.eWaste > 0 ? v.eWaste.toFixed(2) : '-'}</td>
                            <td>R${Math.round(v.eLoss)}</td>
                            <td class="text-slate-600">${v.violations || 0}</td>
                            <td class="text-slate-600">${v.duration ? (v.duration / 60).toFixed(1) : '-'}</td>
                            <td class="${v.maxSpeed > speedLimit ? 'text-red-600 font-bold' : 'text-slate-600'}">${v.maxSpeed || '-'}</td>
                            <td>R${Math.round(v.sLoss)}</td>
                            <td class="italic text-red-600">R${Math.round(v.tLoss)}</td>
                            <td class="${scoreClass} ${v.score < 70 ? 'bg-red-50' : ''}">${v.actEff > 0 ? Math.round(v.score) + '%' + scoreIcon : '-'}</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td class="text-left px-4 italic font-black text-blue-600 border-l-4 border-l-blue-500">${v.reg}</td>
                            <td class="text-slate-400">${v.gpsDist.toFixed(0)}</td>
                            <td>${v.km.toFixed(0)}</td>
                            <td class="text-blue-600">${v.lit > 0 ? v.lit.toFixed(1) : '-'}</td>
                            <td class="${v.actEff > 0 && v.actEff < target ? 'text-red-500' : v.actEff > 0 ? 'text-emerald-600' : ''}">${v.actEff > 0 ? v.actEff.toFixed(2) : '-'}</td>
                            <td>${v.eWaste > 0 ? v.eWaste.toFixed(2) : '-'}</td>
                            <td>R${Math.round(v.eLoss)}</td>
                            <td class="text-slate-400">${v.violations || 0}</td>
                            <td>R${Math.round(v.sLoss)}</td>
                            <td class="italic text-red-600">R${Math.round(v.tLoss)}</td>
                            <td class="${scoreClass} ${v.score < 70 ? 'bg-red-50' : ''}">${v.actEff > 0 ? Math.round(v.score) + '%' + scoreIcon : '-'}</td>
                        </tr>
                    `;
                }
            }).join('');

                    // Chart
            new Chart(document.getElementById('lossChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Efficiency', 'Behavior'],
                    datasets: [{
                        data: [eLossSum, sLossSum],
                        backgroundColor: ['#0f172a', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '75%', plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold', family: 'Outfit', size: 10 } } } } }
            });

            // Generate Vehicle Action Report
            const critical = processed.filter(v => v.actEff > 0 && v.actEff < target && (v.violations || 0) > 5);
            const speedOnly = processed.filter(v => (v.actEff >= target || v.actEff === 0) && (v.violations || 0) > 5);
            const effOnly = processed.filter(v => v.actEff > 0 && v.actEff < target && (v.violations || 0) <= 5);
            const acceptable = processed.filter(v => (v.actEff >= target || v.actEff === 0) && (v.violations || 0) <= 5);
            
            let reportHTML = '';
            
            // Critical Section
            if (critical.length > 0) {
                reportHTML += `
                    <div class="bg-red-50 border-l-4 border-red-600 p-6 rounded-xl">
                        <div class="flex items-start gap-3 mb-4">
                            <span class="text-3xl">üö®</span>
                            <div>
                                <h4 class="text-lg font-black uppercase text-red-700 mb-2">Critical - Multiple Issues (Efficiency + Speeding)</h4>
                                <p class="text-xs font-bold text-red-600 mb-3">Required Actions:</p>
                                <ul class="text-xs text-red-700 space-y-1 ml-4">
                                    <li>‚Ä¢ Driver training required</li>
                                    <li>‚Ä¢ Vehicle settings recheck</li>
                                    <li>‚Ä¢ Investigation needed</li>
                                </ul>
                            </div>
                        </div>
                        <div class="overflow-x-auto mt-4">
                            <table class="w-full text-xs border-collapse">
                                <thead>
                                    <tr class="bg-red-900 text-white">
                                        <th class="text-left px-3 py-2 font-black uppercase">Vehicle</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Score</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Speed Events</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Efficiency</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Monthly Loss</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${critical.map(v => `
                                        <tr class="border-b border-red-100">
                                            <td class="px-3 py-2 font-black text-slate-900">${v.reg}</td>
                                            <td class="px-3 py-2 text-center font-black text-red-600">${v.score}%</td>
                                            <td class="px-3 py-2 text-center font-bold text-red-600">${v.violations}</td>
                                            <td class="px-3 py-2 text-center font-bold text-red-600">${v.actEff.toFixed(1)} km/L</td>
                                            <td class="px-3 py-2 text-center font-black text-red-700">R ${Math.round(v.tLoss).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Speeding Only Section
            if (speedOnly.length > 0) {
                reportHTML += `
                    <div class="bg-orange-50 border-l-4 border-orange-500 p-6 rounded-xl">
                        <div class="flex items-start gap-3 mb-4">
                            <span class="text-3xl">‚ö†Ô∏è</span>
                            <div>
                                <h4 class="text-lg font-black uppercase text-orange-700 mb-2">Speeding Violations Only</h4>
                                <p class="text-xs font-bold text-orange-600 mb-3">Required Actions:</p>
                                <ul class="text-xs text-orange-700 space-y-1 ml-4">
                                    <li>‚Ä¢ Vehicle governor settings check</li>
                                    <li>‚Ä¢ Driver counseling session</li>
                                </ul>
                            </div>
                        </div>
                        <div class="overflow-x-auto mt-4">
                            <table class="w-full text-xs border-collapse">
                                <thead>
                                    <tr class="bg-orange-600 text-white">
                                        <th class="text-left px-3 py-2 font-black uppercase">Vehicle</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Score</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Speed Events</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Efficiency</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Monthly Loss</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${speedOnly.map(v => `
                                        <tr class="border-b border-orange-100">
                                            <td class="px-3 py-2 font-black text-slate-900">${v.reg}</td>
                                            <td class="px-3 py-2 text-center font-black text-orange-600">${v.score}%</td>
                                            <td class="px-3 py-2 text-center font-bold text-orange-600">${v.violations}</td>
                                            <td class="px-3 py-2 text-center font-bold text-emerald-600">${v.actEff > 0 ? v.actEff.toFixed(1) + ' km/L' : '-'}</td>
                                            <td class="px-3 py-2 text-center font-black text-orange-700">R ${Math.round(v.tLoss).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Efficiency Only Section
            if (effOnly.length > 0) {
                reportHTML += `
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-xl">
                        <div class="flex items-start gap-3 mb-4">
                            <span class="text-3xl">üîß</span>
                            <div>
                                <h4 class="text-lg font-black uppercase text-blue-700 mb-2">Maintenance Required - Efficiency Only</h4>
                                <p class="text-xs font-bold text-blue-600 mb-3">Required Actions:</p>
                                <ul class="text-xs text-blue-700 space-y-1 ml-4">
                                    <li>‚Ä¢ Driver training required</li>
                                    <li>‚Ä¢ Vehicle maintenance inspection</li>
                                    <li>‚Ä¢ Settings verification</li>
                                </ul>
                            </div>
                        </div>
                        <div class="overflow-x-auto mt-4">
                            <table class="w-full text-xs border-collapse">
                                <thead>
                                    <tr class="bg-blue-700 text-white">
                                        <th class="text-left px-3 py-2 font-black uppercase">Vehicle</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Score</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Speed Events</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Efficiency</th>
                                        <th class="text-center px-3 py-2 font-black uppercase">Monthly Loss</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${effOnly.map(v => `
                                        <tr class="border-b border-blue-100">
                                            <td class="px-3 py-2 font-black text-slate-900">${v.reg}</td>
                                            <td class="px-3 py-2 text-center font-black text-blue-600">${v.score}%</td>
                                            <td class="px-3 py-2 text-center font-bold text-slate-400">${v.violations}</td>
                                            <td class="px-3 py-2 text-center font-bold text-blue-600">${v.actEff.toFixed(1)} km/L</td>
                                            <td class="px-3 py-2 text-center font-black text-blue-700">R ${Math.round(v.tLoss).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Acceptable Performance
            if (acceptable.length > 0) {
                reportHTML += `
                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-6 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">‚úÖ</span>
                            <div>
                                <h4 class="text-lg font-black uppercase text-emerald-700">Acceptable Performance</h4>
                                <p class="text-xs text-emerald-600 mt-1">${acceptable.length} vehicles meeting standards - continue current practices</p>
                          
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('actionReport').innerHTML = reportHTML;
        });
    </script>
</body>

</html>
