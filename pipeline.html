<!DOCTYPE html>
<html lang="en">
<head>
<script type="module" src="firebase-helper.js"></script>    
    <meta charset="UTF-8">
    <title>Fleet Intel | Prospect Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #e2e8f0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 260px; background: #0f172a; border-right: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; padding: 2rem 1rem; }
        .logo-area { padding: 0 1rem 3rem 1rem; }
        .nav-item { display: flex; align-items: center; padding: 0.85rem 1rem; margin-bottom: 0.25rem; border-radius: 0.75rem; color: #64748b; text-transform: uppercase; font-size: 11px; font-weight: 900; letter-spacing: 0.1em; transition: all 0.2s ease; text-decoration: none; cursor: pointer; }
        .nav-item.active { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .main-wrapper { flex: 1; overflow-y: auto; padding: 3rem; background: radial-gradient(circle at top right, #0f172a, #020617); }
        .prospect-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.5rem; padding: 2rem; transition: 0.3s; }
        .prospect-card:hover { border-color: #10b981; transform: translateY(-5px); }
        .badge { background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; }
        .status-badge { padding: 6px 12px; border-radius: 8px; font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; }
        .status-not-started { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
        .status-in-progress { background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.2); }
        .status-complete { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="logo-area"><img src="Logo.png" alt="Logo" style="max-width: 140px;"></div>
        <nav>
            <a href="index.html" class="nav-item">Dashboard</a>
            <a href="pipeline.html" class="nav-item active">Prospect Pipeline</a>
            <a href="database.html" class="nav-item">Active Database</a>
            <a href="audit.html" class="nav-item">Forensic Audit</a>
        </nav>
    </aside>

    <main class="main-wrapper">
        <header class="flex justify-between items-end mb-14">
            <div>
                <p class="text-[10px] font-black uppercase tracking-[0.4em] text-emerald-500 mb-2">New Business Intelligence</p>
                <h1 class="text-5xl font-black italic uppercase tracking-tighter text-white">Prospect <span class="opacity-30">Pipeline</span></h1>
            </div>
            <div class="text-right">
                <span id="p-count" class="text-3xl font-black italic text-white">0</span>
                <p class="text-[9px] font-black uppercase text-white/30 tracking-widest">Leads Detected</p>
            </div>
        </header>

        <div id="pipeline-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8r_qkYyGtq25WUfTw1W0nxeETXYy03FR46_imbRQepdzQkDJbhxrN-M6xuq5OatsM/exec';

        function getAuditStatusBadge(prospect) {
            const status = prospect.auditStatus || 'not-started';
            
            if (status === 'complete') {
                return `<div class="status-badge status-complete">✓ Audit Complete</div>`;
            } else if (status === 'in-progress') {
                const lastEdited = prospect.lastEditedDate ? new Date(prospect.lastEditedDate).toLocaleDateString() : '';
                return `<div class="status-badge status-in-progress">⏳ In Progress ${lastEdited ? '(' + lastEdited + ')' : ''}</div>`;
            } else {
                return `<div class="status-badge status-not-started">○ Not Started</div>`;
            }
        }

      async  function renderPipeline() {
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const pipeline = allClients.filter(c => c.status === 'prospect');
            
            const container = document.getElementById('pipeline-grid');
            document.getElementById('p-count').innerText = pipeline.length;

            if (pipeline.length === 0) {
                container.innerHTML = `<div class="col-span-full py-20 text-center opacity-20 font-black uppercase tracking-widest text-xs">No prospects in system.</div>`;
                return;
            }

            container.innerHTML = pipeline.map((p) => {
                const fleetLabel = p.fleetSizeConfirmed ? 'Confirmed Fleet' : 'Estimated Fleet';
                const auditBadge = getAuditStatusBadge(p);
                
                return `
                <div class="prospect-card">
                    <div class="flex justify-between items-start mb-6">
                        <span class="badge">${p.city || 'NATIONAL'}</span>
                        <div class="flex gap-4">
                            <button onclick="window.location.href='create.html?editId=${p.id}'" class="text-white/20 hover:text-emerald-500 transition text-[10px] font-black uppercase tracking-widest">Edit</button>
                            <button onclick="deleteProspect('${p.id}')" class="text-white/20 hover:text-red-500 transition text-[10px] font-black uppercase tracking-widest">Delete</button>
                        </div>
                    </div>
                    <h3 class="text-2xl font-black italic text-white uppercase mb-1 truncate">${p.company}</h3>
                    <p class="text-emerald-500 text-[10px] font-black uppercase tracking-widest mb-2">${p.contactName || 'NO CONTACT'}</p>
                    ${auditBadge}
                    <div class="space-y-3 mb-8 border-t border-white/5 pt-6 mt-6">
                        <div class="flex justify-between text-[10px] font-bold">
                            <span class="uppercase text-white/30 font-black">${fleetLabel}</span>
                            <span class="${p.fleetSizeConfirmed ? 'text-emerald-400' : ''}">${p.fleetSize || 0} Units</span>
                        </div>
                        ${p.auditResults ? `
                        <div class="flex justify-between text-[10px] font-bold">
                            <span class="uppercase text-white/30 font-black">Total Loss</span>
                            <span class="text-red-400">R ${p.auditResults.wholesaleTotalLoss.toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="runAudit('${p.company}')" class="flex-1 bg-white/5 border border-white/10 py-3 rounded-xl text-[9px] font-black uppercase hover:bg-white/10 transition">
                            ${p.auditStatus === 'complete' ? 'View Audit' : p.auditStatus === 'in-progress' ? 'Continue Audit' : 'Run Audit'}
                        </button>
                        <button onclick="convertToActive('${p.id || p.company}')" class="flex-1 bg-emerald-500 text-slate-900 py-3 rounded-xl text-[9px] font-black uppercase hover:scale-105 transition shadow-lg">Convert</button>
                    </div>
                </div>
            `}).join('');
        }

       async function deleteProspect(id) {
            if (confirm("Delete this prospect record? This will also delete it from Google Sheets and any audit data.")) {
                let clients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
                const prospect = clients.find(c => c.id == id);
                
                if(prospect) {
                    const companyKey = prospect.company.toUpperCase().replace(/\s+/g, '_');
                    const companyName = prospect.company;
                    
                    // Delete audit draft
                    const draftKey = `AUDIT_DRAFT_${companyKey}`;
                    await cloudStorage.removeItem(draftKey);
                    
                    // Delete CSV mappings
                    await cloudStorage.removeItem(`CSV_MAPPING_${companyKey}_usage`);
                    await cloudStorage.removeItem(`CSV_MAPPING_${companyKey}_speed`);
                    
                    // Delete from Google Sheet
                    deleteFromSheet(companyName);
                }
                
                // Remove from clients list
                clients = clients.filter(c => c.id != id);
                await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(clients));
                renderPipeline();
            }
        }

       async function convertToActive(id) {
            console.log('Converting prospect with ID/Company:', id);
            
            let clients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            console.log('All clients:', clients);
            
            // Find client by ID or by company name
            let index = clients.findIndex(c => c.id == id || c.company === id);
            
            console.log('Found client at index:', index);
            
            if (index === -1) {
                alert('❌ Error: Client not found\n\nSearched: ' + id);
                return;
            }
            
            const client = clients[index];
            const companyName = client.company;
            const companyKey = companyName.toUpperCase().replace(/\s+/g, '_');
            
            // Load audit data to get fleet details
            const draftKey = 'AUDIT_DRAFT_' + companyKey;
            const savedDraft = await cloudStorage.getItem(draftKey);
            let auditData = {};
            
            if (savedDraft) {
                try {
                    const draft = JSON.parse(savedDraft);
                    auditData = draft.auditData || {};
                } catch(e) {
                    console.error('Error loading audit data:', e);
                }
            }
            
            // Build fleet array from audit data
            const fleetArray = Object.keys(auditData).map(key => {
                const v = auditData[key];
                return {
                    reg: v.reg || key,
                    type: v.type || 'Heavy',
                    make: v.make || '',
                    model: v.model || '',
                    year: v.year || '',
                    usedFor: v.usedFor || 'Long Distance',
                    targetKmL: v.targetKmL || client.targetCons || '2.3'
                };
            });
            
            // Update client to active status
            clients[index] = {
                ...client,
                status: 'active',
                convertedDate: new Date().toLocaleDateString(),
                
                // Ensure all required fields
                id: client.id || 'client-' + Date.now(),
                company: client.company || 'Unknown Company',
                contactName: client.contactName || '',
                email: client.email || '',
                reportSchedule: client.reportSchedule || 'weekly',
                fleetSize: fleetArray.length || client.fleetSize || 0,
                speedLimit: parseInt(client.speedLimit) || 80,
                fuelPrice: parseFloat(client.fuelPrice) || 21.50,
                targetCons: parseFloat(client.targetCons) || 2.3,
                lastReportSent: null,
                reportHistory: [],
                notes: client.notes || '',
                fleet: fleetArray,
                
                // Keep audit results
                auditResults: client.auditResults || null,
                auditStatus: client.auditStatus || 'complete'
            };
            
            console.log('Updated client:', clients[index]);
            
            // Save to await cloudStorage
            await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(clients));
            
            // Update Google Sheet status
            updateSheetStatus(companyName, 'Active')
                .then(() => {
                    console.log('✅ Sheet updated successfully');
                    alert(`✅ ${companyName} converted to Active Client!\n\nFleet Size: ${fleetArray.length} vehicles\nRedirecting to Active Database...`);
                    window.location.href = 'database.html';
                })
                .catch(err => {
                    console.error('Sheet update error:', err);
                    alert(`✅ ${companyName} converted to Active Client locally!\n\nFleet Size: ${fleetArray.length} vehicles\n\nNote: Could not update Google Sheet (will sync later)\n\nRedirecting to Active Database...`);
                    window.location.href = 'database.html';
                });
        }

        function updateSheetStatus(companyName, status) {
            return new Promise((resolve, reject) => {
                const callback = 'sheetCallback_' + Date.now();
                
                window[callback] = function(data) {
                    delete window[callback];
                    const script = document.getElementById(callback);
                    if (script) script.remove();
                    
                    if (data.success) {
                        console.log('✅ Sheet updated:', companyName, '→', status);
                        resolve(data);
                    } else {
                        console.error('❌ Sheet update failed:', data.error);
                        reject(data.error);
                    }
                };
                
                const script = document.createElement('script');
                script.id = callback;
                script.src = `${APPS_SCRIPT_URL}?company=${encodeURIComponent(companyName)}&action=update&status=${encodeURIComponent(status)}&callback=${callback}`;
                script.onerror = () => {
                    delete window[callback];
                    console.error('❌ Sheet update error');
                    reject('Script failed');
                };
                
                document.body.appendChild(script);
            });
        }

        function deleteFromSheet(companyName) {
            return new Promise((resolve, reject) => {
                const callback = 'sheetCallback_' + Date.now();
                
                window[callback] = function(data) {
                    delete window[callback];
                    const script = document.getElementById(callback);
                    if (script) script.remove();
                    
                    if (data.success) {
                        console.log('✅ Deleted from sheet:', companyName);
                        resolve(data);
                    } else {
                        console.log('⚠️ Not found in sheet:', companyName);
                        resolve(data);
                    }
                };
                
                const script = document.createElement('script');
                script.id = callback;
                script.src = `${APPS_SCRIPT_URL}?company=${encodeURIComponent(companyName)}&action=delete&callback=${callback}`;
                script.onerror = () => {
                    delete window[callback];
                    reject('Script failed');
                };
                
                document.body.appendChild(script);
            });
        }

        function runAudit(name) { 
            window.location.href = `audit.html?client=${encodeURIComponent(name)}`; 
        }
        
        window.onload = renderPipeline;
    </script>
</body>

</html>


