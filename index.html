<!DOCTYPE html>
<html lang="en">
<head>
	<script type="module" src="firebase-helper.js"></script>
    <meta charset="UTF-8">
    <title>Fleet Intel | Executive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #e2e8f0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 260px; background: #0f172a; border-right: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; padding: 2rem 1rem; }
        .logo-area { padding: 0 1rem 3rem 1rem; }
        .nav-item { display: flex; align-items: center; padding: 0.85rem 1rem; margin-bottom: 0.25rem; border-radius: 0.75rem; color: #64748b; text-transform: uppercase; font-size: 11px; font-weight: 900; letter-spacing: 0.1em; transition: all 0.2s ease; text-decoration: none; cursor: pointer; }
        .nav-item.active { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .main-wrapper { flex: 1; overflow-y: auto; padding: 3rem; background: radial-gradient(circle at top right, #0f172a, #020617); }
        .card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.5rem; padding: 2.5rem; transition: all 0.4s; text-decoration: none; display: block; color: inherit; }
        .card:hover { transform: translateY(-10px); border-color: #10b981; }
        .card-label { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.2em; color: #10b981; margin-bottom: 0.75rem; display: block; }
        .card-value { font-size: 3.5rem; font-weight: 900; letter-spacing: -0.04em; line-height: 1; }
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-top: 2rem; }
        .status-tile { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.5rem; padding: 1.5rem; display: flex; flex-direction: column; justify-content: center; min-height: 180px; }
        .btn-action { background: #10b981; color: #020617; padding: 0.85rem; border-radius: 0.75rem; font-weight: 900; text-transform: uppercase; font-size: 10px; text-align: center; transition: all 0.2s; cursor: pointer; border: none; width: 100%; margin-bottom: 0.5rem; text-decoration: none; display: block; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="logo-area"><img src="Logo.png" alt="Logo" style="max-width: 140px;"></div>
        <nav>
	    <a href="index.html" class="nav-item active">Home</a>
            <a href="clients.html" class="nav-item">Clients</a>
            <a href="pipeline.html" class="nav-item">Prospect Pipeline</a>
            <a href="database.html" class="nav-item">Active Database</a>
            <a href="audit.html" class="nav-item">Forensic Audit</a>
        </nav>
    </aside>

    <main class="main-wrapper">
        <header class="flex justify-between items-end mb-14">
            <div>
                <p class="text-[10px] font-black uppercase tracking-[0.4em] text-emerald-500 mb-2">Fleet Command Center</p>
                <h1 class="text-5xl font-black italic uppercase tracking-tighter text-white">System <span class="opacity-30">Status</span></h1>
            </div>
        </header>

        <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="card">
                <span class="card-label">Estimated Potential MRR</span>
                <div class="card-value" id="potential-mrr">R 0</div>
                <p class="text-[9px] text-white/30 uppercase font-black tracking-widest mt-2">Based on Self-Reported Fleet Sizes</p>
            </div>
            <div class="card">
                <span class="card-label" style="color: #60a5fa;">Confirmed Active MRR</span>
                <div class="card-value" id="actual-mrr">R 0</div>
                <p class="text-[9px] text-emerald-500/60 uppercase font-black tracking-widest mt-2">Verified Post-Audit</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-6 mb-10">
            <a href="pipeline.html" class="card"><span class="card-label">Prospect Pipeline</span><div class="card-value text-4xl" id="count-prospects">0</div></a>
            <a href="database.html" class="card"><span class="card-label" style="color: #60a5fa;">Active Database</span><div class="card-value text-4xl" id="count-active">0</div></a>
        </div>

        <div class="bottom-grid">
            <div class="status-tile">
                <span class="text-[10px] font-black uppercase text-white/30 tracking-widest mb-1">Sync Status</span>
                <div id="sync-status" class="text-3xl font-black italic uppercase text-white tracking-tighter">READY</div>
                <button onclick="hardResetSystem()" class="text-[8px] font-black text-red-500/40 uppercase mt-4 hover:text-red-500 transition">Hard Reset Cache</button>
            </div>
            <div class="status-tile">
                <span class="text-[10px] font-black uppercase text-white/30 tracking-widest mb-1">Last Import</span>
                <div id="last-sync-time" class="text-3xl font-black italic uppercase text-emerald-500 tracking-tighter">NEVER</div>
                <p id="last-sync-details" class="text-[9px] font-bold text-white/20 mt-1 uppercase">0 Records</p>
            </div>
            <div class="status-tile bg-emerald-500/5">
                <button onclick="importFromSheet()" class="btn-action" style="background: #60a5fa; color: white;">ðŸ”„ IMPORT FROM SHEET</button>
                <a href="audit.html" class="btn-action">Run Forensic Audit</a>
                <a href="database.html" class="btn-action" style="background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1);">System Registry</a>
            </div>
        </div>
    </main>

    <script>
        const SHEET_ID = '1zssrLcT2jaM8yoQUMS2MGgithXrJMw2wdG-3D2vS3Y8';
        const GID = '1809947636'; // Form_Responses2 tab
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzyplZ3ID9E4v-J1WS55n_obOKBWJVQkwQzD3XYvXzpkNVz5AUy5FsVti8o2AIEQTgo/exec'

        async function hardResetSystem() {
            if(confirm("DANGER: This wipes all clients and resets the system. Continue?")) {
                 await cloudStorage.clear();
                location.reload();
            }
        }

      async function importFromSheet() {
            document.getElementById('sync-status').innerText = "SYNCING...";
            const oldScript = document.getElementById('google-data-script');
            if (oldScript) oldScript.remove();
            const script = document.createElement('script');
            script.id = 'google-data-script';
            script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleResponse&gid=${GID}&t=${Date.now()}`;
            document.body.appendChild(script);
        }

        window.handleResponse = async function(response) {
            try {
                const rows = response.table.rows;
                let existingClients = JSON.parse( await cloudStorage.getItem('FLEET_CLIENTS')) || [];
                
                let filteredClients = existingClients.filter(c => c.status === 'active');
                let newProspects = [];

                rows.forEach((row, index) => {
                    const c = row.c;
                    if (!c || !c[1] || !c[1].v) return;
                    
                    const companyName = String(c[1].v).trim();
                    if (companyName === "" || 
                        companyName === "Company Name" || 
                        companyName.toLowerCase().includes("company name")) return;

                    // Check column J (index 9) for status
                    const sheetStatus = c[9] && c[9].v ? String(c[9].v).toLowerCase() : "";
                    
                    if (sheetStatus === "active") {
                        console.log("Skipping active client:", companyName);
                        return;
                    }

                    const alreadyActive = filteredClients.some(
                        client => client.company.toLowerCase() === companyName.toLowerCase()
                    );
                    
                    if (alreadyActive) {
                        console.log("Skipping - already active in system:", companyName);
                        return;
                    }

                    console.log("Importing prospect:", companyName);

                    newProspects.push({
                        id: "SHEET-" + companyName.replace(/\s+/g, '-') + "-" + Date.now(),
                        company: companyName.toUpperCase(),
                        contactName: c[2] && c[2].v ? String(c[2].v).trim() : "NO CONTACT",
                        email: c[3] && c[3].v ? String(c[3].v).trim() : "no-email@example.com",
                        contactTel: "",
                        fleetSize: (c[4] && c[4].v) ? parseInt(c[4].v) : 0,
                        vehicleTypes: c[5] && c[5].v ? String(c[5].v) : "Unknown",
                        city: "NATIONAL",
                        fuelPrice: 22.50,
                        speedLimit: 80,
                        currentCons: "",
                        targetCons: 2.3,
                        status: 'prospect'
                    });
                });

                console.log("Total prospects imported:", newProspects.length);

                // Mark new prospects in sheet as "Prospect"
                newProspects.forEach(prospect => {
                    updateSheetStatus(prospect.company, 'Prospect');
                });

                 await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify([...filteredClients, ...newProspects]));
                 await cloudStorage.setItem('lastSyncTS', new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                
                document.getElementById('sync-status').innerText = "SUCCESS";
                setTimeout(() => {
                    document.getElementById('sync-status').innerText = "READY";
                }, 2000);
                updateDisplay(); 
            } catch (err) {
                document.getElementById('sync-status').innerText = "ERROR";
                console.error("Sync error:", err);
                alert("Import failed. Check console for details.");
            }
        };

       function updateSheetStatus(companyName, status) {
    return new Promise((resolve, reject) => {
        const callback = 'sheetCallback_' + Date.now();
        
        window[callback] = function(data) {
            delete window[callback];
            const script = document.getElementById(callback);
            if (script) script.remove();
            
            if (data.success) {
                console.log('âœ… Sheet updated:', companyName, 'â†’', status);
                resolve(data);
            } else {
                console.error('âŒ Sheet update failed:', data.error);
                reject(data.error);
            }
        };
        
        const script = document.createElement('script');
        script.id = callback;
        script.src = `${APPS_SCRIPT_URL}?company=${encodeURIComponent(companyName)}&action=update&status=${encodeURIComponent(status)}&callback=${callback}`;
        script.onerror = () => {
            delete window[callback];
            console.error('âŒ Sheet update error: Script failed to load');
            reject('Script failed to load');
        };
        
        document.body.appendChild(script);
    });
}

        function calculateMRR(fleetArray) {
            if (!fleetArray || fleetArray.length === 0) return 0;
            const managementTotal = fleetArray.length * 1500;
            const vehicleTotal = fleetArray.reduce((sum, item) => sum + (Number(item.fleetSize) || 0), 0) * 200;
            return managementTotal + vehicleTotal;
        }

        async function updateDisplay() {
            const all = JSON.parse( await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const p = all.filter(c => c.status === 'prospect');
            const a = all.filter(c => c.status === 'active');
            const ts =  await cloudStorage.getItem('lastSyncTS') || 'NEVER';

            document.getElementById('count-prospects').innerText = p.length;
            document.getElementById('count-active').innerText = a.length;
            document.getElementById('last-sync-time').innerText = ts;
            document.getElementById('last-sync-details').innerText = `${p.length} PROSPECTS IMPORTED`;
            
            document.getElementById('potential-mrr').innerText = `R ${calculateMRR(p).toLocaleString()}`;
            document.getElementById('actual-mrr').innerText = `R ${calculateMRR(a).toLocaleString()}`;
        }
        
        window.onload = updateDisplay;
    </script>
</body>

</html>


