<!DOCTYPE html>
<html lang="en">
<head>
	<script type="module" src="firebase-helper.js"></script>
    <meta charset="UTF-8">
    <title>Fleet Intel | Active Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
	        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #e2e8f0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 260px; background: #0f172a; border-right: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; padding: 2rem 1rem; }
        .logo-area { padding: 0 1rem 3rem 1rem; }
        .nav-item { display: flex; align-items: center; padding: 0.85rem 1rem; margin-bottom: 0.25rem; border-radius: 0.75rem; color: #64748b; text-transform: uppercase; font-size: 11px; font-weight: 900; letter-spacing: 0.1em; transition: all 0.2s ease; text-decoration: none; cursor: pointer; }
        .nav-item.active { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .main-wrapper { flex: 1; overflow-y: auto; padding: 3rem; background: radial-gradient(circle at top right, #0f172a, #020617); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 1.5rem; text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: 900; font-style: italic; }
        .stat-label { font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.5; margin-top: 0.5rem; }
        
        .alert-panel { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; }
        .alert-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .alert-item:hover { opacity: 0.7; }
        
        .filter-bar { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 1rem 1.5rem; margin-bottom: 2rem; display: flex; justify-between; align-items: center; }
        .filter-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 10px; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: #60a5fa; color: #020617; }
        .filter-btn:hover { background: rgba(255,255,255,0.1); }
        
        .client-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.5rem; padding: 1.75rem; transition: 0.3s; position: relative; }
        .client-card:hover { border-color: #60a5fa; transform: translateY(-5px); }
        .client-card.overdue { border-color: rgba(239, 68, 68, 0.5); }
        .client-card.due-soon { border-color: rgba(251, 191, 36, 0.5); }
        
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; display: inline-block; }
        .status-weekly { background: rgba(96, 165, 250, 0.1); color: #60a5fa; }
        .status-monthly { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
        .status-overdue { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .status-due-soon { background: rgba(251, 191, 36, 0.1); color: #fbbf24; }
        
        .action-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 0.65rem 1rem; border-radius: 0.75rem; font-size: 9px; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: all 0.2s; text-align: center; }
        .action-btn:hover { background: rgba(255,255,255,0.1); }
        .action-btn.primary { background: #60a5fa; color: #020617; }
        .action-btn.success { background: #10b981; color: #020617; }
        .action-btn.warning { background: #fbbf24; color: #020617; }
        .action-btn.danger { background: #ef4444; color: white; }
        
        #editModal, #notesModal, #historyModal { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); z-index: 100; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-card { background: #0f172a; border: 2px solid #60a5fa; border-radius: 2rem; width: 100%; max-width: 600px; padding: 2.5rem; margin: auto; }
        
        input, select, textarea { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; padding: 0.75rem; color: white; width: 100%; font-size: 13px; margin-top: 0.25rem; font-family: 'Outfit', sans-serif; }
        textarea { min-height: 100px; resize: vertical; }
        label { font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; display: block; margin-bottom: 0.25rem; }
        
        .history-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; }
		
		#successModal { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
.success-card { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border: 2px solid #10b981; border-radius: 2rem; width: 100%; max-width: 500px; padding: 3rem; text-align: center; animation: slideIn 0.3s ease; }
@keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.success-icon { font-size: 4rem; margin-bottom: 1rem; }
.success-title { font-size: 1.5rem; font-weight: 900; color: #10b981; margin-bottom: 1rem; text-transform: uppercase; font-style: italic; }
.success-details { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 1rem; padding: 1.5rem; margin: 1.5rem 0; text-align: left; }
.success-detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.success-detail-row:last-child { border-bottom: none; }
.success-steps { text-align: left; margin: 1.5rem 0; }
.success-step { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; margin: 0.5rem 0; background: rgba(255,255,255,0.03); border-radius: 0.75rem; font-size: 13px; }
.success-step-num { background: #10b981; color: #020617; font-weight: 900; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="logo-area"><img src="Logo.png" alt="Logo" style="max-width: 140px;"></div>
        <nav>
            <a href="index.html" class="nav-item">Dashboard</a>
            <a href="pipeline.html" class="nav-item">Prospect Pipeline</a>
            <a href="database.html" class="nav-item active">Active Database</a>
            <a href="audit.html" class="nav-item">Forensic Audit</a>
        </nav>
    </aside>

    <main class="main-wrapper">
        <header class="flex justify-between items-end mb-8">
            <div>
                <p class="text-[10px] font-black uppercase tracking-[0.4em] text-blue-400 mb-2">Live Portfolio Management</p>
                <h1 class="text-5xl font-black italic uppercase tracking-tighter text-white">Active <span class="opacity-30">Database</span></h1>
            </div>
            <div class="flex gap-3">
                <button onclick="sendWeeklyReminders()" class="action-btn warning">üìÖ Weekly Reports Due</button>
                <button onclick="sendMonthlyReminders()" class="action-btn primary">üìÜ Monthly Reports Due</button>
                <button onclick="exportDatabase()" class="action-btn">üì• Export</button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div id="stat-total" class="stat-value text-blue-400">0</div>
                <div class="stat-label">Active Clients</div>
            </div>
            <div class="stat-card">
                <div id="stat-weekly" class="stat-value text-sky-400">0</div>
                <div class="stat-label">Weekly Reports</div>
            </div>
            <div class="stat-card">
                <div id="stat-monthly" class="stat-value text-purple-400">0</div>
                <div class="stat-label">Monthly Reports</div>
            </div>
            <div class="stat-card">
                <div id="stat-overdue" class="stat-value text-red-400">0</div>
                <div class="stat-label">Overdue</div>
            </div>
        </div>

        <div id="alerts-panel" class="alert-panel" style="display: none;">
            <h3 class="text-sm font-black uppercase text-red-400 mb-3">üö® Action Required</h3>
            <div id="alerts-list"></div>
        </div>

        <div class="filter-bar">
            <div class="flex gap-2">
                <button class="filter-btn active" onclick="filterClients('all', event)">All</button>
                <button class="filter-btn" onclick="filterClients('weekly', event)">üìÖ Weekly</button>
                <button class="filter-btn" onclick="filterClients('monthly', event)">üìÜ Monthly</button>
                <button class="filter-btn" onclick="filterClients('overdue', event)">üî¥ Overdue</button>
            </div>
            <div class="flex gap-2 items-center">
                <span class="text-[9px] font-black uppercase opacity-50">Sort:</span>
                <select id="sortBy" onchange="renderDatabase()" class="action-btn" style="width: auto; padding: 0.5rem;">
                    <option value="name">Name</option>
                    <option value="nextDue">Next Due</option>
                    <option value="schedule">Schedule</option>
                </select>
            </div>
        </div>

        <div id="database-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal">
        <div class="modal-card">
            <h2 class="text-2xl font-black italic uppercase text-white mb-6">Edit <span class="text-blue-400">Client</span></h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                <div><label>Company Name</label><input type="text" id="editName" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label>Contact Person</label><input type="text" id="editContact"></div>
                    <div><label>Email</label><input type="email" id="editEmail"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label>Fleet Size</label><input type="number" id="editFleet"></div>
                    <div><label>Speed Limit</label><input type="number" id="editSpeed" value="80"></div>
                </div>
                <div><label>Report Schedule</label>
                    <select id="editSchedule">
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()" class="flex-1 action-btn">Cancel</button>
                    <button type="submit" class="flex-1 action-btn success">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal">
        <div class="modal-card">
            <h2 class="text-2xl font-black italic uppercase text-white mb-6">Client <span class="text-yellow-400">Notes</span></h2>
            <input type="hidden" id="notesId">
            <textarea id="notesText" placeholder="Add notes, special instructions, preferences..." style="min-height: 150px;"></textarea>
            <div class="flex gap-3 pt-4">
                <button onclick="closeNotesModal()" class="flex-1 action-btn">Cancel</button>
                <button onclick="saveNotes()" class="flex-1 action-btn success">Save Notes</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal">
        <div class="modal-card" style="max-width: 800px;">
            <h2 class="text-2xl font-black italic uppercase text-white mb-6">Report <span class="text-emerald-400">History</span></h2>
            <div id="historyContent"></div>
            <button onclick="closeHistoryModal()" class="action-btn mt-6 w-full">Close</button>
        </div>
    </div>
	
	<!-- Fleet Management Modal -->
    <div id="fleetModal" style="display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); z-index: 100; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
        <div class="modal-card" style="max-width: 1400px; width: 100%;">
            <h2 class="text-2xl font-black italic uppercase text-white mb-6">Fleet Management: <span id="fleetClientName" class="text-blue-400"></span></h2>
            <input type="hidden" id="fleetClientId">
            
            <div style="overflow-x: auto; margin-bottom: 2rem;">
                <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                    <thead>
                        <tr style="background: #60a5fa;">
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">#</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Registration</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Type</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Make</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Model</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Year</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Used For</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Target km/L</th>
                            <th style="padding: 0.75rem; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #020617;">Remove</th>
                        </tr>
                    </thead>
                    <tbody id="fleetTableBody"></tbody>
                </table>
            </div>
            
            <div class="flex gap-3">
                <button onclick="addVehicleRow()" class="action-btn primary">‚ûï Add Vehicle</button>
                <button onclick="saveFleet()" class="flex-1 action-btn success">üíæ Save Fleet</button>
                <button onclick="closeFleetModal()" class="action-btn">Cancel</button>
            </div>
        </div>
    </div>

  <!-- Custom Report Modal -->
<div id="customReportModal" style="display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); z-index: 100; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
    <div class="modal-card" style="max-width: 700px;">
        <h2 class="text-2xl font-black italic uppercase text-white mb-6">Custom <span class="text-yellow-400">Report</span></h2>
        <input type="hidden" id="reportClientId">
        
        <div class="space-y-4">
            <!-- Date Range -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label>Start Date</label>
                    <input type="date" id="reportStartDate">
                </div>
                <div>
                    <label>End Date</label>
                    <input type="date" id="reportEndDate">
                </div>
            </div>
            
            <!-- Report Focus -->
            <div>
                <label>Report Focus</label>
                <select id="reportFocus">
                    <option value="combined">Combined (Speed + Efficiency)</option>
                    <option value="speed">Speed Violations Only</option>
                    <option value="efficiency">Fuel Efficiency Only</option>
                </select>
            </div>
            
            <!-- Vehicle Selection -->
            <div>
                <label>Vehicles</label>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; padding: 1rem; max-height: 200px; overflow-y: auto;">
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="selectAllVehicles" onchange="toggleAllVehicles()" checked style="width: 18px; height: 18px;">
                            <span style="font-weight: 700; color: #60a5fa;">Select All Vehicles</span>
                        </label>
                    </div>
                    <div id="vehicleCheckboxes" style="display: grid; gap: 0.5rem;"></div>
                </div>
            </div>
            
            <!-- Export Format -->
            <div>
                <label>Export Format</label>
                <select id="reportFormat">
                    <option value="pdf">PDF Report</option>
                    <option value="csv">CSV Data Export</option>
                </select>
            </div>
        </div>
        
        <div class="flex gap-3 pt-6">
            <button onclick="closeCustomReportModal()" class="flex-1 action-btn">Cancel</button>
            <button onclick="generateCustomReport()" class="flex-1 action-btn success">üìä Generate Report</button>
        </div>
    </div>
</div>

   <!-- Success Modal -->
    <div id="successModal">
        <div class="success-card">
            <div class="success-icon">‚úÖ</div>
            <h2 class="success-title">Form Generated!</h2>
            <div class="success-details">
                <div class="success-detail-row">
                    <span style="opacity: 0.5; font-weight: 900; text-transform: uppercase; font-size: 10px;">Client</span>
                    <span id="successClient" style="font-weight: 700;"></span>
                </div>
                <div class="success-detail-row">
                    <span style="opacity: 0.5; font-weight: 900; text-transform: uppercase; font-size: 10px;">Period</span>
                    <span id="successPeriod" style="font-weight: 700; color: #10b981;"></span>
                </div>
            </div>
            <div class="success-steps">
                <p style="font-weight: 900; text-transform: uppercase; font-size: 10px; opacity: 0.5; margin-bottom: 1rem; letter-spacing: 0.1em;">üìß Next Steps</p>
                <div class="success-step">
                    <div class="success-step-num">1</div>
                    <span>Email HTML file to client</span>
                </div>
                <div class="success-step">
                    <div class="success-step-num">2</div>
                    <span>Client fills and downloads JSON</span>
                </div>
                <div class="success-step">
                    <div class="success-step-num">3</div>
                    <span>Client emails JSON back</span>
                </div>
                <div class="success-step">
                    <div class="success-step-num">4</div>
                    <span>You import for audit</span>
                </div>
            </div>
            <button onclick="closeSuccessModal()" class="action-btn success" style="width: 100%; margin-top: 1rem;">Got It!</button>
        </div>
    </div>
    <script>
	const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzyplZ3ID9E4v-J1WS55n_obOKBWJVQkwQzD3XYvXzpkNVz5AUy5FsVti8o2AIEQTgo/exec'
	        let currentFilter = 'all';
        const BACKUP_URL = 'https://script.google.com/macros/s/AKfycbwuWyGboNTuisBBVLWMJpFZchPaCqUnCd8cE92UzFJ3PIzMPzw1-Zzvv1CfM1sWlVVi/exec';

       async function initVehicleDatabase() {
            const savedDB = await cloudStorage.getItem('VEHICLE_SPECS_DB');
            if (!savedDB) {
                const defaultDB = {
                    'Volvo FH440': { targetKmL: 2.3, type: 'Heavy', category: 'Long Distance' },
                    'Volvo FH460': { targetKmL: 2.2, type: 'Heavy', category: 'Long Distance' },
                    'Scania R450': { targetKmL: 2.4, type: 'Heavy', category: 'Long Distance' },
                    'Scania G460': { targetKmL: 2.3, type: 'Heavy', category: 'Long Distance' },
                    'Mercedes Actros 1844': { targetKmL: 2.2, type: 'Heavy', category: 'Long Distance' },
                    'Mercedes Actros 2644': { targetKmL: 2.1, type: 'Heavy', category: 'Long Distance' },
                    'MAN TGX 440': { targetKmL: 2.3, type: 'Heavy', category: 'Long Distance' },
                    'MAN TGS 440': { targetKmL: 2.2, type: 'Heavy', category: 'Long Distance' },
                    'Isuzu FTR 850': { targetKmL: 3.5, type: 'Medium', category: 'Local Full' },
                    'Isuzu FSR 800': { targetKmL: 3.8, type: 'Medium', category: 'Local Full' },
                    'Hino 500': { targetKmL: 3.6, type: 'Medium', category: 'Local Full' },
                    'UD Quon': { targetKmL: 2.4, type: 'Heavy', category: 'Long Distance' }
                };
                await cloudStorage.setItem('VEHICLE_SPECS_DB', JSON.stringify(defaultDB));
            }
        }

        function getNextDueDate(client) {
            const lastSent = client.lastReportSent ? new Date(client.lastReportSent) : new Date();
            const schedule = client.reportSchedule || 'monthly';
            
            if (schedule === 'weekly') {
                lastSent.setDate(lastSent.getDate() + 7);
            } else {
                lastSent.setMonth(lastSent.getMonth() + 1);
            }
            
            return lastSent;
        }

        function getDaysUntilDue(client) {
            const nextDue = getNextDueDate(client);
            const now = new Date();
            const diff = Math.ceil((nextDue - now) / (1000 * 60 * 60 * 24));
            return diff;
        }

        function getClientStatus(client) {
            const daysUntil = getDaysUntilDue(client);
            
            if (daysUntil < 0) return 'overdue';
            if (daysUntil <= 2) return 'due-soon';
            if (client.reportSchedule === 'weekly') return 'weekly';
            return 'monthly';
        }

       async function renderDatabase() {
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
			console.log('Clients in storage:', allClients);
            const active = allClients.filter(c => c.status === 'active');
            const container = document.getElementById('database-grid');
			if (!container) {
    console.error('‚ùå database-grid not found in DOM');
    return;
}
            const sortBy = document.getElementById('sortBy').value;
            
            let weeklyCount = active.filter(c => c.reportSchedule === 'weekly').length;
            let monthlyCount = active.filter(c => c.reportSchedule === 'monthly').length;
            let overdueCount = active.filter(c => getDaysUntilDue(c) < 0).length;
            
            document.getElementById('stat-total').innerText = active.length;
            document.getElementById('stat-weekly').innerText = weeklyCount;
            document.getElementById('stat-monthly').innerText = monthlyCount;
            document.getElementById('stat-overdue').innerText = overdueCount;
            
            let sortedClients = [...active];
            if (sortBy === 'nextDue') {
                sortedClients.sort((a, b) => getDaysUntilDue(a) - getDaysUntilDue(b));
            } else if (sortBy === 'schedule') {
                sortedClients.sort((a, b) => (a.reportSchedule || 'monthly').localeCompare(b.reportSchedule || 'monthly'));
            } else {
                sortedClients.sort((a, b) => (a.company || '').localeCompare(b.company || ''));
            }
            
            let filteredClients = sortedClients.filter(client => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'weekly') return client.reportSchedule === 'weekly';
                if (currentFilter === 'monthly') return client.reportSchedule === 'monthly';
                if (currentFilter === 'overdue') return getDaysUntilDue(client) < 0;
                return true;
            });
            
            generateAlerts(active);
            
            if (filteredClients.length === 0) {
                container.innerHTML = `<div class="col-span-full py-20 text-center opacity-20 font-black uppercase text-xs">No clients found</div>`;
                return;
            }
            
            container.innerHTML = filteredClients.map(client => {
                const status = getClientStatus(client);
                const daysUntil = getDaysUntilDue(client);
                const statusClass = `status-${status}`;
                const cardClass = status === 'overdue' ? 'overdue' : status === 'due-soon' ? 'due-soon' : '';
                
                let dueText = '';
                if (daysUntil < 0) dueText = `Overdue by ${Math.abs(daysUntil)} days`;
                else if (daysUntil === 0) dueText = 'Due Today!';
                else if (daysUntil === 1) dueText = 'Due Tomorrow';
                else dueText = `Due in ${daysUntil} days`;
                
                const history = client.reportHistory || [];
                
                return `
                    <div class="client-card ${cardClass}">
                        <div class="flex justify-between items-start mb-4">
                            <span class="status-badge ${statusClass}">${(client.reportSchedule || 'monthly').toUpperCase()}</span>
                           <div class="flex gap-3">
    <button onclick="openEdit('${client.id}')" class="text-white/20 hover:text-blue-400 transition text-xs">‚öôÔ∏è</button>
    <button onclick="openNotes('${client.id}')" class="text-white/20 hover:text-yellow-400 transition text-xs">üìù</button>
    <button onclick="deleteClient('${client.id}')" class="text-white/20 hover:text-red-400 transition text-xs">üóëÔ∏è</button>
</div>
                        </div>
                        
                        <h3 class="text-2xl font-black italic text-white uppercase mb-1 truncate">${client.company}</h3>
                        <p class="text-blue-400 text-[10px] font-black uppercase tracking-widest mb-4">${client.contactName || 'No Contact'}</p>
                        
                        <div class="space-y-2 mb-4 border-t border-white/5 pt-4">
                            <div class="flex justify-between text-[10px] font-bold">
                                <span class="uppercase text-white/30">Next Report</span>
                                <span class="${daysUntil < 0 ? 'text-red-400' : daysUntil <= 2 ? 'text-yellow-400' : ''}">${dueText}</span>
                            </div>
                            <div class="flex justify-between text-[10px] font-bold">
    <span class="uppercase text-white/30">Fleet Size</span>
    <span>${client.fleet ? client.fleet.length : (client.vehicles ? client.vehicles.length : (client.fleetSize || 0))} Units</span>
</div>
                            <div class="flex justify-between text-[10px] font-bold">
                                <span class="uppercase text-white/30">Reports Sent</span>
                                <span>${history.length} Total</span>
                            </div>
                        </div>
                        
                        ${client.notes ? `<div class="text-[9px] text-yellow-400/60 italic mb-4">üìù ${client.notes.substring(0, 50)}${client.notes.length > 50 ? '...' : ''}</div>` : ''}
                        
                  <div class="grid grid-cols-2 gap-2">
    <button onclick="generateWeeklyForm('${client.id}')" class="action-btn success col-span-2">
        üìã Generate Weekly Form
    </button>
    <button onclick="syncFromAudit('${client.id}')" class="action-btn primary">
        üì• Sync from Audit
    </button>
    <button onclick="manageFleet('${client.id}')" class="action-btn primary">
        üöõ Manage Fleet
    </button>
    <button onclick="openAudit('${client.company}')" class="action-btn col-span-2" style="background: #60a5fa; color: #020617;">
        üìä View/Run Audit
    </button>
    <button onclick="openCustomReport('${client.id}')" class="action-btn warning col-span-2">
        üìà Custom Report
    </button>
    ${history.length > 0 ? `
    <button onclick="viewHistory('${client.id}')" class="action-btn col-span-2">
        üìä View History
    </button>
    ` : ''}
    <button onclick="sendReminder('${client.id}')" class="action-btn warning col-span-2">
        ‚úâÔ∏è Send Reminder
    </button>
</div>
                </div>
            `;
        }).join('');
    }
	
async function deleteClient(id) {
    if (confirm("‚ö†Ô∏è Delete this active client?\n\nThis will:\n‚Ä¢ Remove from database\n‚Ä¢ Delete from Google Sheet\n‚Ä¢ Remove all fleet data\n\nThis cannot be undone!")) {
        let clients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
        const client = clients.find(c => c.id == id);
        
        if(client) {
            const companyName = client.company;
            deleteFromSheet(companyName);
        }
        
        clients = clients.filter(c => c.id != id);
        await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(clients));
        renderDatabase();
    }
}

function deleteFromSheet(companyName) {
    return new Promise((resolve, reject) => {
        const callback = 'sheetCallback_' + Date.now();
        
        window[callback] = function(data) {
            delete window[callback];
            const script = document.getElementById(callback);
            if (script) script.remove();
            
            if (data.success) {
                console.log('‚úÖ Deleted from sheet:', companyName);
                resolve(data);
            } else {
                console.log('‚ö†Ô∏è Not found in sheet:', companyName);
                resolve(data);
            }
        };
        
        const script = document.createElement('script');
        script.id = callback;
        script.src = `${APPS_SCRIPT_URL}?company=${encodeURIComponent(companyName)}&action=delete&callback=${callback}`;
        script.onerror = () => {
            delete window[callback];
            reject('Script failed');
        };
        
        document.body.appendChild(script);
    });
}

        function generateAlerts(clients) {
            const alertsList = document.getElementById('alerts-list');
            const alertsPanel = document.getElementById('alerts-panel');
            let alerts = [];
            
            const overdue = clients.filter(c => getDaysUntilDue(c) < 0);
            const dueSoon = clients.filter(c => getDaysUntilDue(c) >= 0 && getDaysUntilDue(c) <= 2);
            
            if (overdue.length > 0) {
                alerts.push(`<div class="alert-item text-red-400" onclick="filterClients('overdue', event)">üö® ${overdue.length} client${overdue.length > 1 ? 's' : ''} overdue - Click to view</div>`);
            }
            
            if (dueSoon.length > 0) {
                alerts.push(`<div class="alert-item text-yellow-400">‚è∞ ${dueSoon.length} report${dueSoon.length > 1 ? 's' : ''} due in next 2 days</div>`);
            }
            
            if (alerts.length > 0) {
                alertsList.innerHTML = alerts.join('');
                alertsPanel.style.display = 'block';
            } else {
                alertsPanel.style.display = 'none';
            }
        }

        function filterClients(filter, event) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderDatabase();
        }

      async function openEdit(id) {
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = client.company || '';
            document.getElementById('editContact').value = client.contactName || '';
            document.getElementById('editEmail').value = client.email || '';
            document.getElementById('editFleet').value = client.fleetSize || 0;
            document.getElementById('editSpeed').value = client.speedLimit || 80;
            document.getElementById('editSchedule').value = client.reportSchedule || 'monthly';
            document.getElementById('editModal').style.display = 'flex';
        }

async function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

document.getElementById('editForm').onsubmit = async function(e) {
    e.preventDefault();
    const id = document.getElementById('editId').value;

    // Safely parse the stored data
    let data = await cloudStorage.getItem('FLEET_CLIENTS');
    let allClients = JSON.parse(data || "[]");

    const index = allClients.findIndex(c => c.id === id);

    if (index !== -1) {
        allClients[index] = {
            ...allClients[index],
            company: document.getElementById('editName').value,
            contactName: document.getElementById('editContact').value,
            email: document.getElementById('editEmail').value,
            fleetSize: parseInt(document.getElementById('editFleet').value),
            speedLimit: parseInt(document.getElementById('editSpeed').value),
            reportSchedule: document.getElementById('editSchedule').value
        };

        await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClients));
        closeEditModal();
        renderDatabase();
    }
};



      async function openNotes(id) {
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            document.getElementById('notesId').value = id;
            document.getElementById('notesText').value = client.notes || '';
            document.getElementById('notesModal').style.display = 'flex';
        }

        function closeNotesModal() {
            document.getElementById('notesModal').style.display = 'none';
        }

       async function saveNotes() {
            const id = document.getElementById('notesId').value;
            let allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const index = allClients.findIndex(c => c.id === id);
            
            if (index !== -1) {
                allClients[index].notes = document.getElementById('notesText').value;
                await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClients));
                closeNotesModal();
                renderDatabase();
            }
        }

     async function viewHistory(id) {
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            console.log('Viewing history for:', client.company, client.reportHistory); // Debug
            const history = client.reportHistory || [];
            const content = document.getElementById('historyContent');
            
            if (history.length === 0) {
                content.innerHTML = '<p class="text-center text-white/30 py-10 font-bold">No report history yet. Generate your first form to start tracking!</p>';
            } else {
                content.innerHTML = history.map(h => `
                    <div class="history-item">
                        <div class="flex justify-between mb-2">
                            <span class="font-black text-emerald-400 text-sm">${new Date(h.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                            <span class="text-xs text-white/50 uppercase font-bold">${h.type || 'Report'}</span>
                        </div>
                        <div class="text-sm text-white/70">‚úì ${h.vehicles || 0} vehicles ‚Ä¢ Form Generated</div>
                    </div>
                `).join('');
            }
            
            document.getElementById('historyModal').style.display = 'flex';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
			
	 // Fleet Management Functions
        let currentFleetData = [];
        
       async function manageFleet(clientId) {
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const client = allClients.find(c => c.id === clientId);
            if (!client) return;
            
            document.getElementById('fleetClientId').value = clientId;
            document.getElementById('fleetClientName').textContent = client.company;
            
            // Load existing fleet or create empty array
            currentFleetData = client.fleet || [];
            
            renderFleetTable();
            document.getElementById('fleetModal').style.display = 'flex';
        }
        
async function openCustomReport(clientId) {
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const client = allClients.find(c => c.id === clientId);
    
    if (!client) {
        alert('‚ùå Client not found!');
        return;
    }
    
    // Check for audit data
    const draftKey = 'AUDIT_DRAFT_' + client.company.toUpperCase().replace(/\s+/g, '_');
    const savedDraft = await cloudStorage.getItem(draftKey);
    
    if (!savedDraft) {
        alert('‚ö†Ô∏è No audit data found!\n\nPlease run an audit first by clicking "üìä View/Run Audit".');
        return;
    }
    
    try {
        const draft = JSON.parse(savedDraft);
        const auditData = draft.auditData || {};
        const vehicles = Object.keys(auditData);
        
        if (vehicles.length === 0) {
            alert('‚ö†Ô∏è No vehicles in audit data.');
            return;
        }
        
        document.getElementById('reportClientId').value = clientId;
        
        // Set dates
        const endDate = new Date();
        const startDate = new Date(Date.now() - 30*24*60*60*1000);
        document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
        
        // Populate checkboxes
        const checkboxContainer = document.getElementById('vehicleCheckboxes');
        checkboxContainer.innerHTML = vehicles.map(key => {
            const v = auditData[key];
            return `
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="vehicle-checkbox" value="${key}" checked style="width: 16px; height: 16px;">
                    <span style="font-size: 13px; font-weight: 600;">${v.reg} <span style="opacity: 0.5;">(${v.type || 'Heavy'})</span></span>
                </label>
            `;
        }).join('');
        
        document.getElementById('customReportModal').style.display = 'flex';
        
    } catch (e) {
        console.error('Error:', e);
        alert('‚ùå Error loading audit data.');
    }
}

function closeCustomReportModal() {
    document.getElementById('customReportModal').style.display = 'none';
}

function toggleAllVehicles() {
    const selectAll = document.getElementById('selectAllVehicles').checked;
    document.querySelectorAll('.vehicle-checkbox').forEach(cb => {
        cb.checked = selectAll;
    });
}

async function generateCustomReport() {
    const clientId = document.getElementById('reportClientId').value;
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    const focus = document.getElementById('reportFocus').value;
    const format = document.getElementById('reportFormat').value;
    
    // Get client
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const client = allClients.find(c => c.id === clientId);
    
    if (!client) {
        alert('‚ö†Ô∏è Client not found');
        return;
    }
    
    // Get selected vehicle KEYS (not indices)
    const selectedVehicleKeys = Array.from(document.querySelectorAll('.vehicle-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedVehicleKeys.length === 0) {
        alert('‚ö†Ô∏è Please select at least one vehicle');
        return;
    }
    
    // Load audit data
    const draftKey = 'AUDIT_DRAFT_' + client.company.toUpperCase().replace(/\s+/g, '_');
    const draft = JSON.parse(await cloudStorage.getItem(draftKey));
    
    if (!draft || !draft.auditData) {
        alert('‚ö†Ô∏è No audit data found. Please run an audit first.');
        return;
    }
    
    const fullAuditData = draft.auditData;
    
    // Filter to selected vehicles
    const filteredData = {};
    selectedVehicleKeys.forEach(key => {
        if (fullAuditData[key]) {
            filteredData[key] = fullAuditData[key];
        }
    });
    
    // Prepare report
    const target = parseFloat(draft.target) || 2.3;
    const limit = parseFloat(draft.speedLimit) || 80;
    
    const fleet = Object.keys(filteredData).map(k => {
        const v = filteredData[k];
        const odoVal = parseFloat(v.odo) || 0;
        const manualL = parseFloat(v.liters) || 0;
        const events = v.speeds ? v.speeds.filter(s => s > limit).length : 0;
        
        return {
            reg: v.reg,
            type: v.type,
            gpsDist: v.gps,
            mK: odoVal,
            mL: manualL,
            violations: events,
            duration: v.duration || 0,
            maxSpeed: v.maxSpeed || 0,
            speeds: v.speeds || []  // pass raw speed events through
        };
    });
    
    const dateRangeText = `${startDate} - ${endDate}`;
    
    const reportPayload = {
        client: {
            company: client.company,
            town: client.city || "Cape Town",
            target: target
        },
        month: dateRangeText,
        fleet: fleet,
        speedLimit: limit,
        wPrice: 21.50,
        isActive: client.status === 'active',
        customReport: {
            focus: focus,
            vehicleCount: selectedVehicleKeys.length,
            totalVehicles: Object.keys(fullAuditData).length,
            dateRange: { from: startDate, to: endDate },
            format: format
        }
    };
    
    // Save to await cloudStorage
    await cloudStorage.setItem('AUDIT_FINAL', JSON.stringify(reportPayload));
    
    console.log('üìä Custom report generated:', reportPayload);
    console.log('üöó Filtered to', selectedVehicleKeys.length, 'of', Object.keys(fullAuditData).length, 'vehicles');
    
    // Close modal
    closeCustomReportModal();
    
    // Open report or export CSV
    if (format === 'pdf') {
        const reportWindow = window.open('report-custom.html', '_blank');
        if (!reportWindow) {
            alert('‚ö†Ô∏è Pop-up blocked! Please allow pop-ups.');
        } else {
            alert(`‚úÖ Report Generated!\n\nVehicles: ${selectedVehicleKeys.length} of ${Object.keys(fullAuditData).length}\n\nüí° Use Ctrl+P to save as PDF`);
        }
    } else {
        // CSV export
        let csv = 'Registration,Type,GPS KM,Manual KM,Liters,Violations,Max Speed\n';
        fleet.forEach(v => {
            csv += `${v.reg},${v.type},${v.gpsDist},${v.mK},${v.mL},${v.violations},${v.maxSpeed}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${client.company}_${dateRangeText}_Report.csv`;
        a.click();
        URL.revokeObjectURL(url);
        alert('‚úÖ CSV exported!');
    }
}

       function openAudit(clientName) {
           window.location.href = 'audit.html?client=' + encodeURIComponent(clientName);
       }

        function closeFleetModal() {
            document.getElementById('fleetModal').style.display = 'none';
        }
        
        function renderFleetTable() {
            const tbody = document.getElementById('fleetTableBody');
            
            if (currentFleetData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.3); font-weight: 900; text-transform: uppercase; font-size: 11px;">
                            No vehicles added yet. Click "‚ûï Add Vehicle" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = currentFleetData.map((v, idx) => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 0.75rem; color: rgba(255,255,255,0.5); font-weight: 700;">${idx + 1}</td>
                    <td style="padding: 0.75rem;">
                        <input type="text" value="${v.reg || ''}" 
                               onchange="updateFleetField(${idx}, 'reg', this.value)"
                               style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; color: white; font-size: 13px;"
                               placeholder="ABC123GP">
                    </td>
                    <td style="padding: 0.75rem;">
                        <select onchange="updateFleetField(${idx}, 'type', this.value)"
                                style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; color: white; font-size: 13px;">
                            <option value="Heavy" ${v.type === 'Heavy' ? 'selected' : ''}>Heavy</option>
                            <option value="Medium" ${v.type === 'Medium' ? 'selected' : ''}>Medium</option>
                        </select>
                    </td>
                    <td style="padding: 0.75rem;">
                        <input type="text" value="${v.make || ''}" 
                               onchange="updateFleetField(${idx}, 'make', this.value)"
                               style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; color: white; font-size: 13px;"
                               placeholder="Volvo">
                    </td>
                    <td style="padding: 0.75rem;">
                        <input type="text" value="${v.model || ''}" 
                               onchange="updateFleetField(${idx}, 'model', this.value)"
                               style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; color: white; font-size: 13px;"
                               placeholder="FH440">
                    </td>
                    <td style="padding: 0.75rem;">
                        <input type="text" value="${v.year || ''}" 
                               onchange="updateFleetField(${idx}, 'year', this.value)"
                               style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; color: white; font-size: 13px;"
                               placeholder="2022">
                    </td>
                    <td style="padding: 0.75rem;">
                        <select onchange="updateFleetField(${idx}, 'usedFor', this.value)"
                                style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; color: white; font-size: 13px;">
                            <option value="Long Distance" ${v.usedFor === 'Long Distance' ? 'selected' : ''}>Long Distance</option>
                            <option value="Local Full" ${v.usedFor === 'Local Full' ? 'selected' : ''}>Local Full</option>
                            <option value="Local 50%" ${v.usedFor === 'Local 50%' ? 'selected' : ''}>Local 50%</option>
                        </select>
                    </td>
                    <td style="padding: 0.75rem;">
                        <input type="number" step="0.1" value="${v.targetKmL || '2.3'}" 
                               onchange="updateFleetField(${idx}, 'targetKmL', this.value)"
                               style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; color: white; font-size: 13px;"
                               placeholder="2.3">
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">
                        <button onclick="removeVehicle(${idx})" 
                                style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 11px; font-weight: 900; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function addVehicleRow() {
            currentFleetData.push({
                reg: '',
                type: 'Heavy',
                make: '',
                model: '',
                year: '',
                usedFor: 'Long Distance',
                targetKmL: '2.3'
            });
            renderFleetTable();
        }
        
        function updateFleetField(index, field, value) {
            if (currentFleetData[index]) {
                currentFleetData[index][field] = value;
            }
        }
        
        function removeVehicle(index) {
            if (confirm('Remove this vehicle from the fleet?')) {
                currentFleetData.splice(index, 1);
                renderFleetTable();
            }
        }
        
      async function saveFleet() {
            const clientId = document.getElementById('fleetClientId').value;
            let allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const index = allClients.findIndex(c => c.id === clientId);
            
            if (index !== -1) {
                const validVehicles = currentFleetData.filter(v => v.reg && v.reg.trim() !== '');
                
                if (validVehicles.length === 0) {
                    alert('‚ö†Ô∏è Please add at least one vehicle with a registration number.');
                    return;
                }
                
                allClients[index].fleet = validVehicles;
                allClients[index].fleetSize = validVehicles.length;
                await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClients));
                
                closeFleetModal();
                renderDatabase();
                alert(`‚úÖ Fleet saved! ${validVehicles.length} vehicle${validVehicles.length !== 1 ? 's' : ''} registered.`);
            }
        }

      async function syncFromAudit(clientId) {
            const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
            const client = allClients.find(c => c.id === clientId);
            
            if (!client) {
                alert('‚ùå Client not found!');
                return;
            }
            
            const draftKey = 'AUDIT_DRAFT_' + client.company.toUpperCase().replace(/\s+/g, '_');
            const savedDraft = await cloudStorage.getItem(draftKey);
            
            if (!savedDraft) {
                alert('‚ö†Ô∏è No audit data found for this client.\n\nPlease ensure an audit has been completed first, or use "üöõ Manage Fleet" to add vehicles manually.');
                return;
            }
            
            try {
                const draft = JSON.parse(savedDraft);
                
                if (!draft.auditData || Object.keys(draft.auditData).length === 0) {
                    alert('‚ö†Ô∏è Audit data is empty.\n\nPlease complete an audit first, or use "üöõ Manage Fleet" to add vehicles manually.');
                    return;
                }
                
                const fleet = Object.keys(draft.auditData).map(key => {
                    const v = draft.auditData[key];
                    return {
                        reg: v.reg || key,
                        type: v.type || 'Heavy',
                        make: v.make || '',
                        model: v.model || '',
                        year: v.year || '',
                        usedFor: v.usedFor || 'Long Distance',
                        targetKmL: v.targetKmL || '2.3'
                    };
                });
                
                const index = allClients.findIndex(c => c.id === clientId);
                if (index !== -1) {
                    allClients[index].fleet = fleet;
                    allClients[index].fleetSize = fleet.length;
                    await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClients));
                    
                    alert(`‚úÖ Fleet synced successfully!\n\n${fleet.length} vehicle${fleet.length !== 1 ? 's' : ''} imported from audit data.\n\nYou can now generate weekly forms.`);
                    renderDatabase();
                }
            } catch (e) {
                console.error('Error syncing from audit:', e);
                alert('‚ùå Error syncing data. Please try again or contact support.');
            }
        }
    
	async function getFleetForClient(clientId) {
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const client = allClients.find(c => c.id === clientId);

    if (!client) {
        alert('‚ùå Client not found!');
        return null;
    }

    let fleet = client.fleet || client.vehicles || [];

    // Try to recover fleet from audit draft
    if (!fleet || fleet.length === 0) {
        const companyName = client.company || '';
        const draftKey = 'AUDIT_DRAFT_' + companyName.toUpperCase().replace(/\s+/g, '_');
        const savedDraft = await cloudStorage.getItem(draftKey);

        if (savedDraft) {
            try {
                const draft = JSON.parse(savedDraft);

                if (draft.auditData && Object.keys(draft.auditData).length > 0) {
                    fleet = Object.keys(draft.auditData).map(key => {
                        const v = draft.auditData[key];
                        return {
                            reg: v.reg || key,
                            type: v.type || 'Heavy',
                            make: v.make || '',
                            model: v.model || '',
                            year: v.year || '',
                            usedFor: v.usedFor || 'Long Distance',
                            targetKmL: v.targetKmL || '2.3'
                        };
                    });

                    const index = allClients.findIndex(c => c.id === clientId);
                    if (index !== -1) {
                        allClients[index].fleet = fleet;
                        await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClients));
                    }
                }
            } catch (e) {
                console.error('Error parsing audit data:', e);
            }
        }
    }

    // Final check
    if (!fleet || fleet.length === 0) {
        if (confirm(
            '‚ö†Ô∏è No fleet data found!\n\n' +
            '1. Use "üì• Sync from Audit"\n' +
            '2. Or add vehicles manually\n\n' +
            'Would you like to manage fleet now?'
        )) {
            manageFleet(clientId);
        }
        return null;
    }

    return fleet;
}
	
async function generateWeeklyForm(clientId) {
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const client = allClients.find(c => c.id === clientId);

    if (!client) {
        alert('‚ùå Client not found!');
        return;
    }

    const fleet = client.fleet || [];
	console.log('Fleet data:', fleet, 'Type:', typeof fleet, 'Is array:', Array.isArray(fleet));
    if (!fleet) return;

    console.log('Generating weekly form for client:', client);

    const reportType = client.reportSchedule || 'weekly';
        
    // Generate vehicle rows with pre-filled data
        
   const vehicleRows = fleet.map((v, i) => 
        `<tr>
            <td style="text-align:center;color:rgba(255,255,255,0.3);font-weight:900">${i + 1}</td>
            <td class="locked-cell">${v.reg}</td>
            <td class="locked-cell">${v.type}</td>
            <td class="locked-cell">${v.make}</td>
            <td class="locked-cell">${v.model}</td>
            <td class="locked-cell">${v.year}</td>
            <td class="locked-cell">${v.usedFor}</td>
            <td class="locked-cell">${v.targetKmL}</td>
            <td class="editable-cell" style="text-align: center;">
                <input type="checkbox" id="update-${i}">
            </td>
            <td class="editable-cell" style="text-align: center;">
                <input type="checkbox" id="remove-${i}">
            </td>
            <td class="editable-cell">
                <input type="number" id="endOdo-${i}" placeholder="Odo" oninput="updateProgress()">
            </td>
            <td class="editable-cell">
                <input type="number" id="totalKm-${i}" placeholder="KM" oninput="updateProgress()">
            </td>
            <td class="editable-cell">
                <input type="number" id="fuelUsed-${i}" placeholder="Liters" oninput="updateProgress()">
            </td>
            <td class="editable-cell">
                <input type="text" id="notes-${i}" placeholder="Changes...">
            </td>
        </tr>`
    ).join('');
    
    // Generate JavaScript data for the form
    const vehiclesData = fleet.map(v => 
        `{ reg: '${v.reg}', type: '${v.type}', make: '${v.make}', model: '${v.model}', year: '${v.year}', usedFor: '${v.usedFor}', targetKmL: '${v.targetKmL}' }`
    ).join(',\n                ');

    const formHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${client.company} - ${reportType} Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Outfit', sans-serif; 
            background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
            color: #e2e8f0; 
            padding: 2rem;
            min-height: 100vh;
        }
        .container { 
            max-width: 1800px; 
            margin: 0 auto; 
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            border: 1px solid rgba(16, 185, 129, 0.2);
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid rgba(16, 185, 129, 0.3);
        }
        .logo { max-width: 200px; margin-bottom: 1.5rem; }
        .title {
            font-size: 2.5rem;
            font-weight: 900;
            text-transform: uppercase;
            font-style: italic;
            background: linear-gradient(135deg, #10b981, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .info-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 1.5rem;
            border-radius: 1rem;
        }
        .info-label {
            font-size: 0.75rem;
            font-weight: 900;
            text-transform: uppercase;
            color: rgba(16, 185, 129, 0.8);
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }
        .info-value {
            font-size: 1.25rem;
            font-weight: 900;
            color: #10b981;
        }
        .report-type {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid #fbbf24;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .report-type label {
            color: #fbbf24;
            font-weight: 900;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        .report-type select {
            flex: 1;
            background: #0f172a;
            border: 2px solid #fbbf24;
            color: #fbbf24;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 900;
            font-size: 0.875rem;
            outline: none;
        }
        .instructions {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05));
            border-left: 4px solid #fbbf24;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }
        .instructions h3 {
            color: #fbbf24;
            font-weight: 900;
            font-size: 1rem;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }
        .instructions ul {
            list-style: none;
            color: #fde68a;
        }
        .instructions li {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .instructions li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #fbbf24;
            font-weight: bold;
        }
        .progress-section {
            margin-bottom: 2rem;
        }
        .progress-bar {
            background: rgba(15, 23, 42, 0.6);
            height: 12px;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #34d399);
            height: 100%;
            transition: width 0.3s;
            width: 0%;
        }
        .progress-text {
            font-size: 0.875rem;
            color: rgba(16, 185, 129, 0.8);
            font-weight: 700;
        }
        .data-table {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 1.5rem;
            padding: 1.5rem;
            overflow-x: auto;
            margin-bottom: 2rem;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        thead th {
            background: #10b981;
            color: #020617;
            padding: 1rem 0.5rem;
            font-weight: 900;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        thead th:first-child { border-radius: 0.5rem 0 0 0; }
        thead th:last-child { border-radius: 0 0.5rem 0 0; }
        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        tbody tr:hover {
            background: rgba(16, 185, 129, 0.05);
        }
        tbody td {
            padding: 0.75rem 0.5rem;
            color: #e2e8f0;
            font-size: 0.875rem;
        }
        .locked-cell {
            background: rgba(15, 23, 42, 0.8);
            color: rgba(226, 232, 240, 0.6);
        }
        .editable-cell { background: rgba(255, 255, 255, 0.05); }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            background: #0f172a;
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            outline: none;
            transition: all 0.2s;
        }
        input[type="number"]:focus, input[type="text"]:focus {
            border-color: #10b981;
            background: #1e293b;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        input::placeholder { color: rgba(226, 232, 240, 0.3); }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #10b981;
        }
        .add-vehicle-section {
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .add-vehicle-section h3 {
            color: #3b82f6;
            font-weight: 900;
            font-size: 1.1rem;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
        }
        .new-vehicle-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.75rem;
        }
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .btn {
            padding: 1.25rem;
            border: none;
            border-radius: 1rem;
            font-family: 'Outfit', sans-serif;
            font-weight: 900;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #020617;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }
        .btn-add {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 2px dashed rgba(59, 130, 246, 0.5);
            padding: 0.75rem;
            font-size: 0.8rem;
        }
        .btn-add:hover { background: rgba(59, 130, 246, 0.3); }
        .footer {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(226, 232, 240, 0.5);
            font-size: 0.75rem;
        }
        select {
            background: #0f172a;
            border: 2px solid rgba(16, 185, 129, 0.3);
            color: white;
            padding: 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-family: 'Outfit', sans-serif;
            outline: none;
            width: 100%;
        }
        @media (max-width: 768px) {
            .container { padding: 1.5rem; }
            .title { font-size: 1.75rem; }
            .actions { grid-template-columns: 1fr; }
        }
	
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">${client.company}</h1>
            <p style="color: rgba(226, 232, 240, 0.6); font-size: 0.875rem;">Fleet Report - Submit your data</p>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">Client</div>
                <div class="info-value">${client.company}</div>
            </div>
            <div class="info-card">
                <div class="info-label">Generated</div>
                <div class="info-value" id="generated-date">${new Date().toLocaleDateString()}</div>
            </div>
            <div class="info-card">
                <div class="info-label">Vehicles</div>
                <div class="info-value"><span id="vehicle-count">${fleet.length}</span> Units</div>
            </div>
        </div>

        <div class="report-type">
            <label for="report-frequency">Report Type:</label>
            <select id="report-frequency" onchange="updatePeriodDate()">
                <option value="weekly" ${reportType === 'weekly' ? 'selected' : ''}>Weekly Report (Ends Sunday)</option>
                <option value="monthly" ${reportType === 'monthly' ? 'selected' : ''}>Monthly Report (Month End)</option>
            </select>
            <div style="flex: 1;">
                <span style="color: rgba(226, 232, 240, 0.6); font-size: 0.75rem; display: block;">Period Ending:</span>
                <span id="period-date" style="color: #fbbf24; font-weight: 900; font-size: 1rem;">-</span>
            </div>
        </div>

        <div class="instructions">
            <h3>üìã Instructions</h3>
            <ul>
                <li>Review vehicle details - check boxes if updates or removals needed</li>
                <li>Complete <strong>End Odo</strong>, <strong>Total KM</strong>, and <strong>Fuel Used</strong> columns</li>
                <li>You can fill either End Odo OR Total KM (or both for verification)</li>
                <li>Add new vehicles in the section below the table</li>
                <li>Click <strong>Submit Report</strong> when complete</li>
            </ul>
        </div>

        <div class="progress-section">
            <div class="progress-text">
                Progress: <span id="completed-count">0</span> of <span id="total-count">${fleet.length}</span> vehicles completed
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th style="width: 150px;">Registration</th>
                        <th style="width: 80px;">Type</th>
                        <th style="width: 100px;">Make</th>
                        <th style="width: 100px;">Model</th>
                        <th style="width: 60px;">Year</th>
                        <th style="width: 120px;">Used For</th>
                        <th style="width: 80px;">Target km/L</th>
                        <th style="width: 50px;">Update?</th>
                        <th style="width: 50px;">Remove?</th>
                        <th style="width: 120px;">End Odo</th>
                        <th style="width: 110px;">Total KM</th>
                        <th style="width: 110px;">Fuel Used (L)</th>
                        <th style="width: 150px;">Notes</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    ${vehicleRows}
                </tbody>
            </table>
        </div>

   <div class="add-vehicle-section">
    <h3>‚ûï Add New Vehicles</h3>
    <div id="new-vehicles-container"></div>
</div>

<footer class="footer">
  <div class="actions">
    <button class="btn btn-add" onclick="addNewVehicleRow()">+ Add Another Vehicle</button>
    <button class="btn btn-primary" onclick="submitReport()">‚úì Submit Report</button>
    <button class="btn btn-secondary" onclick="clearForm()">‚Üª Reset Form</button>
  </div>
  <p>
    Email this file to: <strong>${client.email || 'reports@fleetintel.co.za'}</strong><br>
    For support, contact your account manager
  </p>
</footer>

  </script>
    const reportData = {
        client: '${client.company}',
        generatedDate: new Date().toISOString(),
        reportType: '${reportType}',
        vehicles: [
            ${vehiclesData}
        ]
    };
    let newVehicleCounter = 0;

    function initForm() {
        updatePeriodDate();
        updateProgress();
    }

    function updatePeriodDate() {
        const type = document.getElementById('report-frequency').value;
        const today = new Date();
        let periodEnd;

        if (type === 'weekly') {
            const dayOfWeek = today.getDay();
            const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
            periodEnd = new Date(today);
            periodEnd.setDate(today.getDate() + daysToSunday - 7);
        } else {
            periodEnd = new Date(today.getFullYear(), today.getMonth(), 0);
        }

        const formatted = periodEnd.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
        document.getElementById('period-date').textContent = formatted;
    }

    function addNewVehicleRow() {
        const container = document.getElementById('new-vehicles-container');
        const id = newVehicleCounter++;

        const row = document.createElement('div');
        row.className = 'new-vehicle-row';
        row.id = 'new-vehicle-' + id;
        row.innerHTML = \`
            <input type="text" placeholder="Registration" id="new-reg-${id}">
            <select id="new-type-${id}">
                <option>Heavy</option>
                <option>Medium</option>
            </select>
            <input type="text" placeholder="Make" id="new-make-${id}">
            <input type="text" placeholder="Model" id="new-model-${id}">
            <input type="text" placeholder="Year" id="new-year-${id}">
            <select id="new-used-${id}">
                <option>Long Distance</option>
                <option>Local Full</option>
                <option>Local 50%</option>
            </select>
            <input type="number" placeholder="Target km/L" id="new-target-${id}" value="2.3">
            <button class="btn-secondary" style="padding: 0.5rem;" onclick="document.getElementById('new-vehicle-${id}').remove()">Remove</button>
        `;
        container.appendChild(row);
    }

    function updateProgress() {
        let completed = 0;
        const total = reportData.vehicles.length;

        reportData.vehicles.forEach((v, index) => {
            const endOdo = document.getElementById('endOdo-' + index).value;
            const totalKm = document.getElementById('totalKm-' + index).value;
            const fuelUsed = document.getElementById('fuelUsed-' + index).value;

            if ((endOdo || totalKm) && fuelUsed) {
                completed++;
            }
        });

        const percentage = (completed / total) * 100;
        document.getElementById('completed-count').textContent = completed;
        document.getElementById('progress-fill').style.width = percentage + '%';
    }

    function submitReport() {
        const submissionData = {
            client: reportData.client,
            reportType: document.getElementById('report-frequency').value,
            periodEnding: document.getElementById('period-date').textContent,
            submittedAt: new Date().toISOString(),
            vehicles: [],
            updates: [],
            removals: [],
            newVehicles: []
        };

        reportData.vehicles.forEach((v, index) => {
            const update = document.getElementById('update-' + index).checked;
            const remove = document.getElementById('remove-' + index).checked;
            const notes = document.getElementById('notes-' + index).value;

            const vehicleData = {
                ...v,
                endOdo: document.getElementById('endOdo-' + index).value || '',
                totalKm: document.getElementById('totalKm-' + index).value || '',
                fuelUsed: document.getElementById('fuelUsed-' + index).value || '',
                notes: notes
            };

            submissionData.vehicles.push(vehicleData);

            if (update) submissionData.updates.push({ reg: v.reg, notes });
            if (remove) submissionData.removals.push({ reg: v.reg, notes });
        });

        for (let i = 0; i < newVehicleCounter; i++) {
            const regEl = document.getElementById('new-reg-' + i);
            const reg = regEl ? regEl.value : null;
            if (reg) {
                submissionData.newVehicles.push({
                    reg: reg,
                    type: document.getElementById('new-type-' + i).value,
                    make: document.getElementById('new-make-' + i).value,
                    model: document.getElementById('new-model-' + i).value,
                    year: document.getElementById('new-year-' + i).value,
                    usedFor: document.getElementById('new-used-' + i).value,
                    targetKmL: document.getElementById('new-target-' + i).value
                });
            }
        }

        const dataStr = JSON.stringify(submissionData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        const type = submissionData.reportType.charAt(0).toUpperCase() + submissionData.reportType.slice(1);
        const filename = 'FleetData_' + reportData.client.replace(/\s+/g, '_') + '_' + type + '_' + new Date().toISOString().split('T')[0] + '.json';
        a.href = url;
        a.download = filename;
        a.click();

        alert('‚úÖ Report submitted successfully!\n\nFile: ' + filename + '\n\nPlease email this file to your fleet manager.');
    }

    function clearForm() {
        if (confirm('Clear all entered data?')) {
            location.reload();
        }
    }

    window.onload = initForm;
		
</script>
</body>
</html>`;

 // Download the form
    const blob = new Blob([formHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = client.company.replace(/\s+/g, '_') + '_' + reportType + '_' + new Date().toISOString().split('T')[0] + '.html';
    a.click();
    URL.revokeObjectURL(url);
    
    // Update client history
    let allClientsUpdated = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const index = allClientsUpdated.findIndex(c => c.id === clientId);
    if (index !== -1) {
        allClientsUpdated[index].lastReportSent = new Date().toISOString();
        if (!allClientsUpdated[index].reportHistory) {
            allClientsUpdated[index].reportHistory = [];
        }
        allClientsUpdated[index].reportHistory.push({
            date: new Date().toISOString(),
            type: reportType,
            generated: true,
            vehicles: fleet.length
        });
        await cloudStorage.setItem('FLEET_CLIENTS', JSON.stringify(allClientsUpdated));
    }
}

function showSuccessModal(clientName, period) {
    document.getElementById('successClient').innerText = clientName;
    document.getElementById('successPeriod').innerText = period.toUpperCase();
    document.getElementById('successModal').style.display = 'flex';
}

function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
    renderDatabase();
}
 async function sendReminder(clientId) {
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const client = allClients.find(c => c.id === clientId);
    
    if (!client) return;
    
    const subject = `${client.reportSchedule === 'weekly' ? 'Weekly' : 'Monthly'} Vehicle Data Required - ${client.company}`;
    const body = `Hi ${client.contactName || 'there'},\n\nYour ${client.reportSchedule} fleet report is due.\n\nPlease fill out the form I sent and return the data file.\n\nThank you!`;
    
    window.location.href = `mailto:${client.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
 async function sendWeeklyReminders() {
        const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
        const weekly = allClients.filter(c => c.status === 'active' && c.reportSchedule === 'weekly' && getDaysUntilDue(c) <= 2);
        
        if (weekly.length === 0) {
            alert('No weekly reports due!');
            return;
        }
        
        alert(`üìÖ ${weekly.length} weekly report${weekly.length > 1 ? 's' : ''} due:\n\n${weekly.map(c => c.company).join('\n')}\n\nGenerate forms and email to clients!`);
    }

 async function sendMonthlyReminders() {
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const monthly = allClients.filter(c => c.status === 'active' && c.reportSchedule === 'monthly' && getDaysUntilDue(c) <= 7);
    
    if (monthly.length === 0) {
        alert('No monthly reports due this week!');
        return;
    }
    
    alert('üìÜ ' + monthly.length + ' monthly report' + (monthly.length > 1 ? 's' : '') + ' due:\n\n' + monthly.map(c => c.company).join('\n') + '\n\nGenerate forms and email to clients!');
}

  async  function exportDatabase() {
    const allClients = JSON.parse(await cloudStorage.getItem('FLEET_CLIENTS')) || [];
    const active = allClients.filter(c => c.status === 'active');
    
    let csv = 'Company,Contact,Email,Fleet Size,Schedule,Next Due,Days Until Due\n';
    active.forEach(c => {
        const daysUntil = getDaysUntilDue(c);
        const nextDue = getNextDueDate(c).toLocaleDateString();
        csv += '"' + c.company + '","' + (c.contactName||'') + '","' + (c.email||'') + '",' + (c.fleetSize||0) + ',"' + (c.reportSchedule||'monthly') + '","' + nextDue + '",' + daysUntil + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'active-clients-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    URL.revokeObjectURL(url);
}

 // Wait for Firebase to initialize before running
setTimeout(async () => {
  await initVehicleDatabase();
  await renderDatabase();
}, 5000);
  
	
//Auto backup 
let backupTimeout;  // <-- declare globally
async function autoBackup() {
  // Auto-backup disabled - data is already in Firebase cloud
  // Use "Backup to Google Drive" button for manual backups
  return;
}

  // Schedule backups every 30 seconds
async function scheduleBackup() {
  clearTimeout(backupTimeout);
  backupTimeout = setTimeout(() => {
    autoBackup();
    scheduleBackup(); // Schedule next backup
  }, 50000); // 30 seconds
}

// Wait for Firebase to initialize, then set up auto-backup
setTimeout(() => {
  if (!window.cloudStorage) {
    console.error('‚ùå cloudStorage not available');
    return;
  }
  
  const originalSetItem = window.cloudStorage.setItem;
  window.cloudStorage.setItem = async function(key, value) {
    const result = await originalSetItem.call(this, key, value);
    if (key === 'FLEET_CLIENTS') {
      autoBackup();
    }
    return result;
  };
  
  scheduleBackup();
  console.log('üõ°Ô∏è Auto-backup enabled');
}, 5000);
</script>
</body>
</html>













































